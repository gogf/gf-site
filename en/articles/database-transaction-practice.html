<!doctype html><html lang=en-US dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-community/社区投稿/Go事务处理最佳实践：保证数据一致性的正确方法" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Go Transaction Processing Best Practices: The Right Way to Ensure Data Consistency | GoFrame - A powerful framework for faster, easier, and more efficient project development</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://goframe.org/en/articles/database-transaction-practice><meta data-rh=true property=og:locale content=en_US><meta data-rh=true property=og:locale:alternate content=zh_Hans><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Go Transaction Processing Best Practices: The Right Way to Ensure Data Consistency | GoFrame - A powerful framework for faster, easier, and more efficient project development"><meta data-rh=true name=description content="An in-depth exploration of transaction processing best practices in Go, including basic transaction operations, isolation level selection, lock strategy optimization, modular design, and distributed transaction solutions. Through an e-commerce order system case study, learn how to build high-performance, reliable transaction processing modules that ensure data consistency and system stability"><meta data-rh=true property=og:description content="An in-depth exploration of transaction processing best practices in Go, including basic transaction operations, isolation level selection, lock strategy optimization, modular design, and distributed transaction solutions. Through an e-commerce order system case study, learn how to build high-performance, reliable transaction processing modules that ensure data consistency and system stability"><meta data-rh=true name=keywords content="GoFrame,Transaction Processing,Data Consistency,Isolation Levels,Optimistic Locking,Distributed Transactions,SAGA Pattern,Modular Design,Error Handling,Performance Optimization"><link data-rh=true rel=icon href=/en/img/favicon.ico><link data-rh=true rel=canonical href=https://goframe.org/en/articles/database-transaction-practice><link data-rh=true rel=alternate href=https://goframe.org/articles/database-transaction-practice hreflang=zh-Hans><link data-rh=true rel=alternate href=https://goframe.org/en/articles/database-transaction-practice hreflang=en-US><link data-rh=true rel=alternate href=https://goframe.org/articles/database-transaction-practice hreflang=x-default><link data-rh=true rel=preconnect href=https://ZQUL8VI47R-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="GoFrame - A powerful framework for faster, easier, and more efficient project development" href=/en/opensearch.xml><script src=https://hm.baidu.com/hm.js?38f38a0626fd7805722db06243cd0fa7 async></script><script src=https://cdn.wwads.cn/js/makemoney.js async></script><link rel=stylesheet href=/en/assets/css/styles.51139f28.css><script src=/en/assets/js/runtime~main.21b3c52d.js defer></script><script src=/en/assets/js/main.2eefe9ce.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/en/><div class=navbar__logo><img src=/en/img/logo2.png alt="GoFrame Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/en/img/logo2.png alt="GoFrame Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" sidebarid=quickSidebar href=/en/quick/install>Quick Start</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/en/docs/core>Documentation</a><div class="navbar__item dropdown dropdown--hoverable"><a class=navbar__link aria-haspopup=true aria-expanded=false role=button sidebarid=courseSidebar href=/en/course>Courses</a><ul class=dropdown__menu><li><a class=dropdown__link sidebarid=courseSidebar href=/en/course/bilibili-video>Video Tutorial(Chinese)</a><li><a class=dropdown__link sidebarid=courseStarBookSidebar href=/en/course/starbook>Practical Tutorial - Star English Book</a><li><a class=dropdown__link sidebarid=courseProximaBookSidebar href=/en/course/proxima-book>Microservice Tutorial - Proxima Book</a></ul></div><a class="navbar__item navbar__link" href=/en/examples/grpc>Examples</a><a class="navbar__item navbar__link" href=/en/showcase>Show Case</a><a class="navbar__item navbar__link" href=/en/release/note>Release</a><a class="navbar__item navbar__link" sidebarid=communitySidebar href=/en/share/group>Community</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class=navbar__link aria-haspopup=true aria-expanded=false role=button href=/en/articles/database-transaction-practice>2.8.x(Latest)</a><ul class=dropdown__menu><li><a aria-current=page class="dropdown__link dropdown__link--active" href=/en/articles/database-transaction-practice>2.8.x(Latest)</a><li><a class=dropdown__link href=/en/2.8.x/docs/cli>2.8.x</a><li><a class=dropdown__link href=/en/2.7.x/docs/design>2.7.x</a><li><a class=dropdown__link href=/en/2.6.x/项目开发>2.6.x</a><li><a class=dropdown__link href=/en/2.5.x/项目开发>2.5.x</a><li><a class=dropdown__link href=/en/2.4.x/开发工具>2.4.x</a><li><a class=dropdown__link href=/en/2.3.x/开发工具>2.3.x</a><li><a class=dropdown__link href=/en/2.2.x/开发工具>2.2.x</a><li><a class=dropdown__link href=/en/2.1.x/开发工具>2.1.x</a><li><a class=dropdown__link href=/en/2.0.x/开发工具>2.0.x</a><li><a class=dropdown__link href=/en/1.16.x/开发工具>1.16.x</a></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>English</a><ul class=dropdown__menu><li><a href=/articles/database-transaction-practice rel="noopener noreferrer" class=dropdown__link lang=zh-Hans>简体中文</a><li><a href=/en/articles/database-transaction-practice rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=en-US>English</a></ul></div><a href=https://github.com/gogf/gf target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/en/share>Community Exchange</a><button aria-label="Expand sidebar category 'Community Exchange'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/en/supportus>Support Us</a><button aria-label="Expand sidebar category 'Support Us'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/en/articles>Community Articles</a><button aria-label="Collapse sidebar category 'Community Articles'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/en/articles/framework-comparison-goframe-beego-iris-gin>Golang Framework Comparison: GoFrame, Beego, Iris and Gin</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/en/articles/database-transaction-practice>Go Transaction Processing Best Practices: The Right Way to Ensure Data Consistency</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/en/articles/use-error-code-gracefully-in-golang>How to Use Error Codes Gracefully in Go Development</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/en/articles/when-to-use-panic-in-go>When to Use Panic? Deep Dive into Go Error Handling Best Practices</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/en/articles/techempower-web-benchmarks-r23>TechEmpower Web Benchmarks Latest Performance Evaluation</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/en/articles/rbac-permission-authentication-in-goframe>Implementing Complete Permission Authentication in Go Applications</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/en/articles/go-sse-implementation-guide>Building High-Performance Real-Time Communication: Go Language SSE Implementation Guide</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/en/articles/database-sharding-in-go>Database Sharding in Go: A Practical E-commerce Case Study</a></ul></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/en/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/en/articles><span itemprop=name>Community Articles</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Go Transaction Processing Best Practices: The Right Way to Ensure Data Consistency</span><meta itemprop=position content=2></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 2.8.x(Latest)</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>When building enterprise-level applications, data consistency is fundamental to ensuring business logic correctness. When a business operation involves multiple database updates, if any step fails, we typically want to revert all changes—this is the core concept of database transactions. This article will explore how to correctly implement transaction processing in the <code>GoFrame</code> framework to ensure data consistency, providing practical examples and best practices.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=1-business-scenarios-and-necessity-of-transaction-processing>1. Business Scenarios and Necessity of Transaction Processing<a href=#1-business-scenarios-and-necessity-of-transaction-processing class=hash-link aria-label="Direct link to 1. Business Scenarios and Necessity of Transaction Processing" title="Direct link to 1. Business Scenarios and Necessity of Transaction Processing">​</a></h2>
<p>Transaction processing is a key mechanism for ensuring the atomicity, consistency, isolation, and durability (ACID) of database operations. Here are several typical business scenarios that require transaction processing to guarantee data consistency:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=11-financial-transfer-systems>1.1 Financial Transfer Systems<a href=#11-financial-transfer-systems class=hash-link aria-label="Direct link to 1.1 Financial Transfer Systems" title="Direct link to 1.1 Financial Transfer Systems">​</a></h3>
<p>The most classic transaction processing scenario is bank transfers, involving balance changes in at least two accounts:</p>
<ul>
<li>Deducting an amount from account A</li>
<li>Adding an amount to account B</li>
</ul>
<p>These two operations must be executed as an atomic unit—either both succeed or both fail. If only half is completed (for example, the deduction succeeds but the deposit fails), it will lead to lost funds or money created out of thin air, causing serious financial problems.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=12-e-commerce-order-processing>1.2 E-commerce Order Processing<a href=#12-e-commerce-order-processing class=hash-link aria-label="Direct link to 1.2 E-commerce Order Processing" title="Direct link to 1.2 E-commerce Order Processing">​</a></h3>
<p>Order creation in e-commerce platforms typically involves multiple related operations:</p>
<ul>
<li>Creating an order record</li>
<li>Updating product inventory</li>
<li>Creating payment records</li>
<li>Generating logistics information</li>
</ul>
<p>If any of these operations fail, the entire order process should be rolled back; otherwise, it may lead to overselling, inventory inconsistencies, or order status confusion.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=13-user-registration-and-associated-data>1.3 User Registration and Associated Data<a href=#13-user-registration-and-associated-data class=hash-link aria-label="Direct link to 1.3 User Registration and Associated Data" title="Direct link to 1.3 User Registration and Associated Data">​</a></h3>
<p>The user registration process may involve operations across multiple tables:</p>
<ul>
<li>Creating basic user information</li>
<li>Creating user preference settings</li>
<li>Initializing user wallet</li>
<li>Assigning default roles and permissions</li>
</ul>
<p>If any of these steps fail, the entire registration process should be rolled back to avoid incomplete user records.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=14-multi-service-collaborative-operations>1.4 Multi-service Collaborative Operations<a href=#14-multi-service-collaborative-operations class=hash-link aria-label="Direct link to 1.4 Multi-service Collaborative Operations" title="Direct link to 1.4 Multi-service Collaborative Operations">​</a></h3>
<p>In microservice architectures, a business operation may involve data changes across multiple services:</p>
<ul>
<li>Updating user status in the user service</li>
<li>Creating a new order in the order service</li>
<li>Reducing inventory in the inventory service</li>
</ul>
<p>This kind of cross-service data consistency is a more complex issue, typically requiring distributed transaction solutions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=2-goframe-transaction-processing-basics>2. GoFrame Transaction Processing Basics<a href=#2-goframe-transaction-processing-basics class=hash-link aria-label="Direct link to 2. GoFrame Transaction Processing Basics" title="Direct link to 2. GoFrame Transaction Processing Basics">​</a></h2>
<p>The <code>GoFrame</code> framework provides a concise yet powerful transaction processing API, offering higher-level abstractions on top of standard database transactions, making transaction processing simpler and safer.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=21-basic-usage-of-goframe-transactions>2.1 Basic Usage of GoFrame Transactions<a href=#21-basic-usage-of-goframe-transactions class=hash-link aria-label="Direct link to 2.1 Basic Usage of GoFrame Transactions" title="Direct link to 2.1 Basic Usage of GoFrame Transactions">​</a></h3>
<p>The <code>ORM</code> component of <code>GoFrame</code> provides two ways of transaction processing:</p>
<ol>
<li>Function callback-based transaction processing (recommended)</li>
<li>Manual transaction start/commit/rollback</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=211-function-callback-based-transaction-processing>2.1.1 Function Callback-based Transaction Processing<a href=#211-function-callback-based-transaction-processing class=hash-link aria-label="Direct link to 2.1.1 Function Callback-based Transaction Processing" title="Direct link to 2.1.1 Function Callback-based Transaction Processing">​</a></h4>
<p>This is the recommended transaction processing method in <code>GoFrame</code>, which automatically handles commit and rollback operations, reducing the possibility of errors:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Using the Transaction method for transaction operations</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Transaction</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> tx </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">TX</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Execute transaction operations here</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// For example, deduct an amount from account A</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> tx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"accounts"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>Decrement</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"balance"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err  </span><span class="token comment" style=color:#8292a2;font-style:italic>// Returning an error will automatically trigger a rollback</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Add an amount to account B</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> tx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"accounts"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>Increment</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"balance"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err  </span><span class="token comment" style=color:#8292a2;font-style:italic>// Returning an error will automatically trigger a rollback</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Returning nil indicates success and will automatically commit the transaction</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Handle transaction error</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=212-manual-transaction-startcommitrollback>2.1.2 Manual Transaction Start/Commit/Rollback<a href=#212-manual-transaction-startcommitrollback class=hash-link aria-label="Direct link to 2.1.2 Manual Transaction Start/Commit/Rollback" title="Direct link to 2.1.2 Manual Transaction Start/Commit/Rollback">​</a></h4>
<p>For more fine-grained control, you can also manually manage transactions:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Begin transaction</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">tx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Begin</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Ensure proper error handling at the end of the function</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        tx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Rollback</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Execute transaction operations</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> tx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"accounts"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token function" style=color:#e6db74>Decrement</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"balance"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> tx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"accounts"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token function" style=color:#e6db74>Increment</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"balance"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Commit transaction</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> tx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Commit</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=22-advanced-features-of-goframe-transaction-processing>2.2 Advanced Features of GoFrame Transaction Processing<a href=#22-advanced-features-of-goframe-transaction-processing class=hash-link aria-label="Direct link to 2.2 Advanced Features of GoFrame Transaction Processing" title="Direct link to 2.2 Advanced Features of GoFrame Transaction Processing">​</a></h3>
<p>The <code>ORM</code> component of <code>GoFrame</code> provides advanced transaction processing features, such as transaction nesting and specifying transaction isolation levels.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=221-safe-transaction-nesting>2.2.1 Safe Transaction Nesting<a href=#221-safe-transaction-nesting class=hash-link aria-label="Direct link to 2.2.1 Safe Transaction Nesting" title="Direct link to 2.2.1 Safe Transaction Nesting">​</a></h4>
<p>In <code>GoFrame</code>, transactions can be safely nested, with inner transactions automatically reusing the connection of the outer transaction:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Outer transaction</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Transaction</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> tx </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">TX</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Operation 1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Nested transaction, automatically reuses the connection of the outer transaction</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Transaction</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> tx2 </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">TX</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// Operation 2</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Operation 3</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=222-specifying-transaction-isolation-level>2.2.2 Specifying Transaction Isolation Level<a href=#222-specifying-transaction-isolation-level class=hash-link aria-label="Direct link to 2.2.2 Specifying Transaction Isolation Level" title="Direct link to 2.2.2 Specifying Transaction Isolation Level">​</a></h4>
<p><code>GoFrame</code> supports setting the isolation level of transactions:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Set isolation level to serializable</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>TransactionWithOptions</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">TransactionOptions</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        IsolationLevel</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> sql</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">LevelSerializable</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> tx </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">TX</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token comment" style=color:#8292a2;font-style:italic>// Transaction operations...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=3-case-study-e-commerce-order-system-transaction-processing>3. Case Study: E-commerce Order System Transaction Processing<a href=#3-case-study-e-commerce-order-system-transaction-processing class=hash-link aria-label="Direct link to 3. Case Study: E-commerce Order System Transaction Processing" title="Direct link to 3. Case Study: E-commerce Order System Transaction Processing">​</a></h2>
<p>Let's demonstrate how to correctly implement transaction processing in <code>GoFrame</code> through an e-commerce order system example. Assume we have the following data tables:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>-- Orders table</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">orders</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>bigint</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>AUTO_INCREMENT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Order ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>bigint</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'User ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">total_amount</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>decimal</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Total order amount'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">status</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>varchar</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>20</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Order status'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">created_at</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>datetime</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Creation time'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>PRIMARY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>ENGINE</span><span class="token operator" style=color:#66d9ef>=</span><span class="token keyword" style=color:#66d9ef>InnoDB</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CHARSET</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">utf8mb4 </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>'Main orders table'</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- Order items table</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">order_items</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>bigint</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>AUTO_INCREMENT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Order item ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">order_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>bigint</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Order ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">product_id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>bigint</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Product ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">quantity</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>int</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Purchase quantity'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">price</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>decimal</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Product unit price'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>PRIMARY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>ENGINE</span><span class="token operator" style=color:#66d9ef>=</span><span class="token keyword" style=color:#66d9ef>InnoDB</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CHARSET</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">utf8mb4 </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>'Order items table'</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- Products table</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">products</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>bigint</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>AUTO_INCREMENT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Product ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">name</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>varchar</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>100</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Product name'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">price</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>decimal</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Product price'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">stock</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>int</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Inventory quantity'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>PRIMARY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>ENGINE</span><span class="token operator" style=color:#66d9ef>=</span><span class="token keyword" style=color:#66d9ef>InnoDB</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CHARSET</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">utf8mb4 </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>'Products table'</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>-- Users table</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>CREATE</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">users</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>bigint</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>AUTO_INCREMENT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'User ID'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">name</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>varchar</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>50</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Username'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">balance</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>decimal</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>10</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>NOT</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>NULL</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'Account balance'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>PRIMARY</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>KEY</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token identifier">id</span><span class="token identifier punctuation" style=color:#f8f8f2>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>ENGINE</span><span class="token operator" style=color:#66d9ef>=</span><span class="token keyword" style=color:#66d9ef>InnoDB</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>DEFAULT</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>CHARSET</span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain">utf8mb4 </span><span class="token keyword" style=color:#66d9ef>COMMENT</span><span class="token operator" style=color:#66d9ef>=</span><span class="token string" style=color:#a6e22e>'Users table'</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=31-defining-models-and-services>3.1 Defining Models and Services<a href=#31-defining-models-and-services class=hash-link aria-label="Direct link to 3.1 Defining Models and Services" title="Direct link to 3.1 Defining Models and Services">​</a></h3>
<p>First, we define the necessary models and service interfaces (showing only core code):</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// entity/orders.go - Order model</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> Order </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Id          </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain">       </span><span class="token comment" style=color:#8292a2;font-style:italic>// Order ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    UserId      </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain">       </span><span class="token comment" style=color:#8292a2;font-style:italic>// User ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    TotalAmount </span><span class="token builtin" style=color:#e6db74>float64</span><span class="token plain">     </span><span class="token comment" style=color:#8292a2;font-style:italic>// Total order amount</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Status      </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic>// Order status</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    CreatedAt   </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gtime</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Time </span><span class="token comment" style=color:#8292a2;font-style:italic>// Creation time</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// entity/order_items.go - Order item model</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> OrderItem </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Id        </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain">   </span><span class="token comment" style=color:#8292a2;font-style:italic>// Order item ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    OrderId   </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain">   </span><span class="token comment" style=color:#8292a2;font-style:italic>// Order ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ProductId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain">   </span><span class="token comment" style=color:#8292a2;font-style:italic>// Product ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Quantity  </span><span class="token builtin" style=color:#e6db74>int</span><span class="token plain">     </span><span class="token comment" style=color:#8292a2;font-style:italic>// Purchase quantity</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Price     </span><span class="token builtin" style=color:#e6db74>float64</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// Product unit price</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// internal/logic/order/order.go</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// OrderItemInput Order input model</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> OrderItemInput </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ProductId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// Product ID</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Quantity  </span><span class="token builtin" style=color:#e6db74>int</span><span class="token plain">   </span><span class="token comment" style=color:#8292a2;font-style:italic>// Purchase quantity</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// OrderService Order service interface</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> OrderService </span><span class="token keyword" style=color:#66d9ef>interface</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Create order</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token function" style=color:#e6db74>CreateOrder</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> items </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderItemInput</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">orderId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=32-implementing-service-logic-with-transaction-processing>3.2 Implementing Service Logic with Transaction Processing<a href=#32-implementing-service-logic-with-transaction-processing class=hash-link aria-label="Direct link to 3.2 Implementing Service Logic with Transaction Processing" title="Direct link to 3.2 Implementing Service Logic with Transaction Processing">​</a></h3>
<p>Below is the service implementation for creating an order with complete transaction processing:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// internal/logic/order/order.go</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> orderService </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	db </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">DB</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Create order method implementation</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">orderService</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>CreateOrder</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> items </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderItemInput</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">orderId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Validation logic outside the transaction</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// ...code for validating user existence omitted...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// Use transaction processing for the entire order creation process</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    err </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">db</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Transaction</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> tx </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">TX</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// Core transaction logic will be implemented in sections below</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>executeOrderTransaction</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> items</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">orderId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>We break down the transaction logic into multiple steps, each implementing a core function:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=321-core-process>3.2.1 Core Process<a href=#321-core-process class=hash-link aria-label="Direct link to 3.2.1 Core Process" title="Direct link to 3.2.1 Core Process">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Execute the core logic of the order transaction</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">orderService</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>executeOrderTransaction</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> items </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderItemInput</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> orderId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 1. Calculate order amount and validate inventory</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    totalAmount</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>calculateTotalAndValidateStock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> items</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 2. Validate user balance</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>validateUserBalance</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> totalAmount</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 3. Create order record</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>createOrderRecord</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> totalAmount</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 4. Create order items and update inventory</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>createOrderItemsAndUpdateStock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> items</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 5. Deduct user balance</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>deductUserBalance</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> totalAmount</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=322-calculate-order-amount-and-validate-inventory>3.2.2 Calculate Order Amount and Validate Inventory<a href=#322-calculate-order-amount-and-validate-inventory class=hash-link aria-label="Direct link to 3.2.2 Calculate Order Amount and Validate Inventory" title="Direct link to 3.2.2 Calculate Order Amount and Validate Inventory">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Calculate order amount and validate inventory</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">orderService</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>calculateTotalAndValidateStock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> items </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderItemInput</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token builtin" style=color:#e6db74>float64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>var</span><span class="token plain"> totalAmount </span><span class="token builtin" style=color:#e6db74>float64</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> item </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>range</span><span class="token plain"> items </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// Check product inventory</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        productStock</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">db</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"products"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> item</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ProductId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>Value</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"stock"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> productStock</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain"> item</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Quantity </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> gerror</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Newf</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"insufficient stock for product: %d"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> item</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ProductId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// Get product price and accumulate amount</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        productPrice</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">db</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"products"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> item</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ProductId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>Value</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"price"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        totalAmount </span><span class="token operator" style=color:#66d9ef>+=</span><span class="token plain"> productPrice</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Float64</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>float64</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">item</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Quantity</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> totalAmount</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=323-validate-user-balance>3.2.3 Validate User Balance<a href=#323-validate-user-balance class=hash-link aria-label="Direct link to 3.2.3 Validate User Balance" title="Direct link to 3.2.3 Validate User Balance">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Validate user balance</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">orderService</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>validateUserBalance</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> totalAmount </span><span class="token builtin" style=color:#e6db74>float64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    userBalance</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">db</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"users"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>Value</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"balance"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> userBalance</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Float64</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain"> totalAmount </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> gerror</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"insufficient balance"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=324-create-order-record>3.2.4 Create Order Record<a href=#324-create-order-record class=hash-link aria-label="Direct link to 3.2.4 Create Order Record" title="Direct link to 3.2.4 Create Order Record">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Create order record</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">orderService</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>createOrderRecord</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> totalAmount </span><span class="token builtin" style=color:#e6db74>float64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">db</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"orders"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>Data</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Map</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token string" style=color:#a6e22e>"user_id"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">      userId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token string" style=color:#a6e22e>"total_amount"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> totalAmount</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token string" style=color:#a6e22e>"status"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">      </span><span class="token string" style=color:#a6e22e>"pending"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token string" style=color:#a6e22e>"created_at"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">   gtime</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Now</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>InsertAndGetId</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=325-create-order-items-and-update-inventory>3.2.5 Create Order Items and Update Inventory<a href=#325-create-order-items-and-update-inventory class=hash-link aria-label="Direct link to 3.2.5 Create Order Items and Update Inventory" title="Direct link to 3.2.5 Create Order Items and Update Inventory">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Create order items and update inventory</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">orderService</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>createOrderItemsAndUpdateStock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> orderId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> items </span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderItemInput</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> item </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>range</span><span class="token plain"> items </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// Get product price</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        productPrice</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">db</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"products"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> item</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ProductId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>Value</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"price"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// Create order item</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">db</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"order_items"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>Data</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Map</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token string" style=color:#a6e22e>"order_id"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">   orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token string" style=color:#a6e22e>"product_id"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> item</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ProductId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token string" style=color:#a6e22e>"quantity"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">   item</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Quantity</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token string" style=color:#a6e22e>"price"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">      productPrice</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Float64</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>Insert</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// Update product inventory</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">db</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"products"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> item</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ProductId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>Decrement</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"stock"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> item</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Quantity</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=326-deduct-user-balance>3.2.6 Deduct User Balance<a href=#326-deduct-user-balance class=hash-link aria-label="Direct link to 3.2.6 Deduct User Balance" title="Direct link to 3.2.6 Deduct User Balance">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Deduct user balance</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">orderService</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>deductUserBalance</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> totalAmount </span><span class="token builtin" style=color:#e6db74>float64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">db</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"users"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> userId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>Decrement</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"balance"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> totalAmount</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>The above code completes the following transaction operations:</p>
<ol>
<li>Calculate order amount and validate inventory</li>
<li>Validate user balance</li>
<li>Create main order record</li>
<li>Create order items and update product inventory</li>
<li>Deduct user balance</li>
</ol>
<p>If any of these steps fail, the entire order creation process will be rolled back, ensuring data consistency.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=4-transaction-processing-considerations-and-best-practices>4. Transaction Processing Considerations and Best Practices<a href=#4-transaction-processing-considerations-and-best-practices class=hash-link aria-label="Direct link to 4. Transaction Processing Considerations and Best Practices" title="Direct link to 4. Transaction Processing Considerations and Best Practices">​</a></h2>
<p>Overreliance on transactions can lead to performance issues, deadlocks, and increased application complexity. Below are some fundamental principles and best practices to consider when using transactions in <code>GoFrame</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=41-controlling-transaction-scope-and-duration>4.1 Controlling Transaction Scope and Duration<a href=#41-controlling-transaction-scope-and-duration class=hash-link aria-label="Direct link to 4.1 Controlling Transaction Scope and Duration" title="Direct link to 4.1 Controlling Transaction Scope and Duration">​</a></h3>
<ol>
<li>
<p><strong>Minimize transaction scope</strong>: Only include database operations that must be executed as atomic units in transactions. Don't include external service requests, HTTP calls, or unnecessary redundant operations.</p>
</li>
<li>
<p><strong>Keep transactions concise</strong>: Transactions should be short and focused, as longer transactions increase lock duration and affect concurrency.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Good practice: Only perform necessary database operations within transactions</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Transaction</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> tx </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">TX</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// Preparation work (such as parameter validation, data preparation) should be done outside the transaction</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// Only execute necessary database operations within the transaction</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=42-properly-handling-errors-and-exceptions>4.2 Properly Handling Errors and Exceptions<a href=#42-properly-handling-errors-and-exceptions class=hash-link aria-label="Direct link to 4.2 Properly Handling Errors and Exceptions" title="Direct link to 4.2 Properly Handling Errors and Exceptions">​</a></h3>
<ol>
<li>
<p><strong>Always check errors</strong>: Check for errors after each database operation and return errors to trigger rollbacks when errors occur.</p>
</li>
<li>
<p><strong>Avoid panics whenever possible</strong>: Uncaught <code>panic</code>s in transactions can lead to connection leaks or database locks being held. In function callback-based transactions, <code>GoFrame</code> automatically handles <code>panic</code>s and rolls back transactions, but in manual transaction mode, use <code>defer</code> and <code>recover</code> to ensure proper cleanup.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Proper error and panic handling in manual transactions</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">tx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Begin</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Use defer to ensure transaction connections are always properly handled</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> p </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>recover</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> p </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		tx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Rollback</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token function" style=color:#e6db74>panic</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">p</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// Optional re-throw or handle panic</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		tx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Rollback</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Execute transaction operations</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=43-database-transaction-performance-optimization>4.3 Database Transaction Performance Optimization<a href=#43-database-transaction-performance-optimization class=hash-link aria-label="Direct link to 4.3 Database Transaction Performance Optimization" title="Direct link to 4.3 Database Transaction Performance Optimization">​</a></h3>
<ol>
<li>
<p><strong>Choose appropriate isolation levels</strong>: Select isolation levels based on business requirements; higher isolation levels affect concurrent performance.</p>
<table><thead><tr><th style=text-align:left>Isolation Level<th style=text-align:left>Description<th style=text-align:left>Characteristics<th style=text-align:left>Application Scenarios<tbody><tr><td style=text-align:left><code>READ UNCOMMITTED</code><td style=text-align:left>Lowest isolation level<td style=text-align:left>No locks, dirty read issues<td style=text-align:left>Report queries with low data consistency requirements<tr><td style=text-align:left><code>READ COMMITTED</code><td style=text-align:left>Medium isolation level<td style=text-align:left>Prevents dirty reads, non-repeatable reads and phantom reads exist<td style=text-align:left>General transaction processing<tr><td style=text-align:left><code>REPEATABLE READ</code><td style=text-align:left>MySQL default isolation level<td style=text-align:left>Prevents dirty reads and non-repeatable reads, phantom reads exist<td style=text-align:left>Business requiring consistent reads<tr><td style=text-align:left><code>SERIALIZABLE</code><td style=text-align:left>Highest isolation level<td style=text-align:left>Complete serialization, prevents all concurrency issues<td style=text-align:left>Financial and high-security requirement scenarios</table>
</li>
<li>
<p><strong>Avoid long transactions</strong>: Long transactions not only hold database locks but can also cause record issues. Consider splitting a large transaction into multiple smaller ones, or use distributed transactions.</p>
</li>
<li>
<p><strong>Optimize lock strategies</strong>: Proper lock strategies can significantly improve transaction concurrency performance.</p>
<ul>
<li>
<p><strong>Use optimistic locking</strong>: In scenarios with low conflict probability, use version numbers or timestamps for optimistic lock control to avoid long-term locking.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Optimistic locking example</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>UpdateWithOptimisticLock</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> id </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Map</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// Query current version</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	version</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"products"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> id</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token function" style=color:#e6db74>Value</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"version"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// Use version number condition for updating</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	data</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token string" style=color:#a6e22e>"version"</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> version</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>+</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	result</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Ctx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token function" style=color:#e6db74>Model</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"products"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> id</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token function" style=color:#e6db74>Where</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"version"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> version</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Int</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token function" style=color:#e6db74>Data</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token function" style=color:#e6db74>Update</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// Check if update was successful</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> result</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>RowsAffected</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> gerror</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"data has been modified by another user, please refresh and try again"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p><strong>Fine-grained lock granularity</strong>: Lock the smallest possible range of data, use row locks instead of table locks, and minimize lock duration as much as possible.</p>
</li>
<li>
<p><strong>Logical query order</strong>: When accessing multiple tables in a transaction, maintain a consistent access order to reduce deadlock risks.</p>
</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=44-transaction-processing-architectural-design>4.4 Transaction Processing Architectural Design<a href=#44-transaction-processing-architectural-design class=hash-link aria-label="Direct link to 4.4 Transaction Processing Architectural Design" title="Direct link to 4.4 Transaction Processing Architectural Design">​</a></h3>
<ol>
<li>
<p><strong>Layered design</strong>: Centralize transaction logic in the service layer, rather than dispersing it across multiple controllers or application components.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// Implement transaction logic in the service layer</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// internal/logic/order/order.go</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">orderService</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>CreateOrder</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> input </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">CreateOrderInput</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">db</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Transaction</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> tx </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">TX</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token comment" style=color:#8292a2;font-style:italic>// ... Complete transaction logic</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Call the service in the controller</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// internal/controller/order/order.go</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">c </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">orderController</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>Create</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">v1</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">CreateOrderReq</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">res </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">v1</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">CreateOrderRes</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// Call the service containing transaction logic</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> c</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">service</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>CreateOrder</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">CreateOrderInput</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token comment" style=color:#8292a2;font-style:italic>// ... Parameter binding</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token comment" style=color:#8292a2;font-style:italic>// ... Error handling</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token comment" style=color:#8292a2;font-style:italic>// ... Response handling</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p><strong>Addressing distributed transactions</strong>: When transactions need to span microservices or databases, consider using reliable message queues, event-driven patterns, or the <code>SAGA</code> pattern.</p>
</li>
<li>
<p><strong>Using transaction nesting judiciously</strong>: Complex transaction nesting can lead to code maintenance difficulties and logical confusion. In <code>GoFrame</code>, inner nested transactions automatically reuse the connection of the outer transaction (called "virtual nesting"), not creating true nested transactions. While this mechanism is technically safe, clear transaction boundaries and responsibility divisions should still be maintained.</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=45-multi-datasource-and-multi-database-transactions>4.5 Multi-datasource and Multi-database Transactions<a href=#45-multi-datasource-and-multi-database-transactions class=hash-link aria-label="Direct link to 4.5 Multi-datasource and Multi-database Transactions" title="Direct link to 4.5 Multi-datasource and Multi-database Transactions">​</a></h3>
<ol>
<li>
<p><strong>Resource localization principle</strong>: Try to ensure related data is in the same database to facilitate local transactions.</p>
</li>
<li>
<p><strong>For necessary cross-database scenarios</strong>: In cases requiring cross-database transactions, consider:</p>
<ul>
<li>
<p>Distributed transaction coordinators (<code>XA</code>)</p>
</li>
<li>
<p>Compensating transactions (<code>SAGA</code>)</p>
</li>
<li>
<p>Message-based eventual consistency solutions</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// A simplified message-driven cross-database transaction example</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 1. First phase of business operation</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>createOrderFirstPhase</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> input </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">model</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderInput</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token builtin" style=color:#e6db74>int64</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>var</span><span class="token plain"> orderId </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"db1"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Transaction</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> tx </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">TX</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token comment" style=color:#8292a2;font-style:italic>// Create order record</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		result</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> tx</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Insert</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"orders"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Map</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token comment" style=color:#8292a2;font-style:italic>/*...*/</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">			</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> result</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>LastInsertId</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">			</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token comment" style=color:#8292a2;font-style:italic>// Send message to trigger next phase</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> mqClient</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Send</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"order_created"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">message</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderCreated</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">			OrderId</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">			</span><span class="token comment" style=color:#8292a2;font-style:italic>// Other data...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> orderId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 2. Listen for messages to process the next phase</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>handleOrderCreated</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">msg </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">message</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">OrderCreated</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>DB</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"db2"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Transaction</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> tx </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gdb</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">TX</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token comment" style=color:#8292a2;font-style:italic>// Process inventory and other database operations</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token comment" style=color:#8292a2;font-style:italic>// If successful, can also send messages for the next step</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">		</span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">	</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=5-conclusion>5. Conclusion<a href=#5-conclusion class=hash-link aria-label="Direct link to 5. Conclusion" title="Direct link to 5. Conclusion">​</a></h2>
<p>The <code>GoFrame</code> framework provides flexible and powerful transaction processing capabilities, enabling developers to ensure data consistency while avoiding common pitfalls. By following the best practices in this article, you will be able to better utilize transactions in practical applications and build robust applications with high data consistency guarantees.</p>
<p>Remember, good transaction design should achieve balance in the following aspects:</p>
<ol>
<li><strong>Appropriate scope</strong>: Only include necessary operations in transactions</li>
<li><strong>Compact duration</strong>: Reduce transaction duration</li>
<li><strong>Correct isolation level</strong>: Choose based on business scenarios</li>
<li><strong>Robust error handling</strong>: Always check and handle errors</li>
<li><strong>Clear layered design</strong>: Centralize transaction logic in the service layer</li>
</ol>
<p>Through proper transaction handling, your application will be able to find an appropriate balance between concurrency, scalability, and data security.</div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/gogf/gf-site/blob/main/docs/community/社区投稿/Go事务处理最佳实践：保证数据一致性的正确方法.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class=theme-last-updated>Last updated<!-- --> on <b><time datetime=2025-03-31T05:04:32.000Z itemprop=dateModified>Mar 31, 2025</time></b> by <b>John</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/en/articles/framework-comparison-goframe-beego-iris-gin><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Golang Framework Comparison: GoFrame, Beego, Iris and Gin</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/en/articles/use-error-code-gracefully-in-golang><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>How to Use Error Codes Gracefully in Go Development</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class=tocContainer_PXzm><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-business-scenarios-and-necessity-of-transaction-processing class="table-of-contents__link toc-highlight">1. Business Scenarios and Necessity of Transaction Processing</a><ul><li><a href=#11-financial-transfer-systems class="table-of-contents__link toc-highlight">1.1 Financial Transfer Systems</a><li><a href=#12-e-commerce-order-processing class="table-of-contents__link toc-highlight">1.2 E-commerce Order Processing</a><li><a href=#13-user-registration-and-associated-data class="table-of-contents__link toc-highlight">1.3 User Registration and Associated Data</a><li><a href=#14-multi-service-collaborative-operations class="table-of-contents__link toc-highlight">1.4 Multi-service Collaborative Operations</a></ul><li><a href=#2-goframe-transaction-processing-basics class="table-of-contents__link toc-highlight">2. GoFrame Transaction Processing Basics</a><ul><li><a href=#21-basic-usage-of-goframe-transactions class="table-of-contents__link toc-highlight">2.1 Basic Usage of GoFrame Transactions</a><li><a href=#22-advanced-features-of-goframe-transaction-processing class="table-of-contents__link toc-highlight">2.2 Advanced Features of GoFrame Transaction Processing</a></ul><li><a href=#3-case-study-e-commerce-order-system-transaction-processing class="table-of-contents__link toc-highlight">3. Case Study: E-commerce Order System Transaction Processing</a><ul><li><a href=#31-defining-models-and-services class="table-of-contents__link toc-highlight">3.1 Defining Models and Services</a><li><a href=#32-implementing-service-logic-with-transaction-processing class="table-of-contents__link toc-highlight">3.2 Implementing Service Logic with Transaction Processing</a></ul><li><a href=#4-transaction-processing-considerations-and-best-practices class="table-of-contents__link toc-highlight">4. Transaction Processing Considerations and Best Practices</a><ul><li><a href=#41-controlling-transaction-scope-and-duration class="table-of-contents__link toc-highlight">4.1 Controlling Transaction Scope and Duration</a><li><a href=#42-properly-handling-errors-and-exceptions class="table-of-contents__link toc-highlight">4.2 Properly Handling Errors and Exceptions</a><li><a href=#43-database-transaction-performance-optimization class="table-of-contents__link toc-highlight">4.3 Database Transaction Performance Optimization</a><li><a href=#44-transaction-processing-architectural-design class="table-of-contents__link toc-highlight">4.4 Transaction Processing Architectural Design</a><li><a href=#45-multi-datasource-and-multi-database-transactions class="table-of-contents__link toc-highlight">4.5 Multi-datasource and Multi-database Transactions</a></ul><li><a href=#5-conclusion class="table-of-contents__link toc-highlight">5. Conclusion</a></ul></div><div class=tocAdBanner_imxD></div></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title>Follow Us On WeChat</div><ul class="footer__items clean-list"><li class=footer__item><img src=/img/wechat.jpg width=110></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright ©2024 GoFrame OpenSource Team</div></div></div></footer></div>