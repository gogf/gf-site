"use strict";(self.webpackChunkgf_site=self.webpackChunkgf_site||[]).push([["57863"],{771851:function(e,t,n){n.r(t),n.d(t,{metadata:()=>o,contentTitle:()=>a,default:()=>h,assets:()=>c,toc:()=>l,frontMatter:()=>i});var o=JSON.parse('{"id":"docs/\u6846\u67B6\u8BBE\u8BA1/Context\u5171\u4EAB\u53D8\u91CF","title":"Context Shared Variables","description":"Transmitting and managing shared variables in context flow using Context from the GoFrame framework. In Go network applications, especially in HTTP/RPC services, Context is a key tool for transmitting asynchronous IO control and context variables. Through the sharing of structured objects, this article demonstrates how to achieve variable transmission during the request process, ensuring consistency and flexibility of variables in the request chain.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/docs/\u6846\u67B6\u8BBE\u8BA1/Context\u5171\u4EAB\u53D8\u91CF.md","sourceDirName":"docs/\u6846\u67B6\u8BBE\u8BA1","slug":"/docs/design/context-variable","permalink":"/en/docs/design/context-variable","draft":false,"unlisted":false,"editUrl":"https://github.com/gogf/gf-site/blob/main/docs/docs/\u6846\u67B6\u8BBE\u8BA1/Context\u5171\u4EAB\u53D8\u91CF.md","tags":[],"version":"current","lastUpdatedBy":"John","lastUpdatedAt":1732433987000,"sidebarPosition":10,"frontMatter":{"slug":"/docs/design/context-variable","title":"Context Shared Variables","sidebar_position":10,"hide_title":true,"keywords":["GoFrame","GoFrame Framework","Context","Context Variables","Shared Variables","Asynchronous IO","HTTP Requests","Session Management","User Information","Middleware"],"description":"Transmitting and managing shared variables in context flow using Context from the GoFrame framework. In Go network applications, especially in HTTP/RPC services, Context is a key tool for transmitting asynchronous IO control and context variables. Through the sharing of structured objects, this article demonstrates how to achieve variable transmission during the request process, ensuring consistency and flexibility of variables in the request chain."},"sidebar":"mainSidebar","previous":{"title":"Golang Enums","permalink":"/en/docs/design/enums"},"next":{"title":"Other Documents","permalink":"/en/docs/other"}}'),s=n("785893"),r=n("250065");let i={slug:"/docs/design/context-variable",title:"Context Shared Variables",sidebar_position:10,hide_title:!0,keywords:["GoFrame","GoFrame Framework","Context","Context Variables","Shared Variables","Asynchronous IO","HTTP Requests","Session Management","User Information","Middleware"],description:"Transmitting and managing shared variables in context flow using Context from the GoFrame framework. In Go network applications, especially in HTTP/RPC services, Context is a key tool for transmitting asynchronous IO control and context variables. Through the sharing of structured objects, this article demonstrates how to achieve variable transmission during the request process, ensuring consistency and flexibility of variables in the request chain."},a=void 0,c={},l=[{value:"1. Structure Definition",id:"1-structure-definition",level:2},{value:"2. Logical Encapsulation",id:"2-logical-encapsulation",level:2},{value:"3. Context Variable Injection",id:"3-context-variable-injection",level:2},{value:"4. Context Variable Usage",id:"4-context-variable-usage",level:2},{value:"Method Definition",id:"method-definition",level:3},{value:"<code>Context</code> Object Retrieval",id:"context-object-retrieval",level:3},{value:"Custom Key-Value",id:"custom-key-value",level:3},{value:"5. Precautions",id:"5-precautions",level:2}];function d(e){let t={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,r.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"Context"})," refers to the standard library ",(0,s.jsx)(t.code,{children:"context.Context"}),", which is an interface object commonly used for ",(0,s.jsx)(t.strong,{children:"asynchronous IO control"})," and ",(0,s.jsx)(t.strong,{children:"transmission of context flow variables"}),". This article aims to demonstrate how to use ",(0,s.jsx)(t.code,{children:"Context"})," to transmit inter-process shared variables."]}),"\n",(0,s.jsxs)(t.p,{children:["In the execution flow of ",(0,s.jsx)(t.code,{children:"Go"}),", especially in ",(0,s.jsx)(t.code,{children:"HTTP/RPC"}),' execution flows, there is no "global variable" method to obtain request parameters; instead, context ',(0,s.jsx)(t.code,{children:"Context"})," variables are passed to subsequent process methods, and ",(0,s.jsx)(t.code,{children:"Context"})," variables contain all the shared variables needed. Moreover, the shared variables in this ",(0,s.jsx)(t.code,{children:"Context"})," should be agreed upon in advance and are often stored in the form of object pointers."]}),"\n",(0,s.jsxs)(t.p,{children:["Sharing variables through ",(0,s.jsx)(t.code,{children:"Context"})," is very simple. Here, we demonstrate how to transmit and use general shared variables in a practical project through an example in a project."]}),"\n",(0,s.jsx)(t.h2,{id:"1-structure-definition",children:"1. Structure Definition"}),"\n",(0,s.jsxs)(t.p,{children:["Context objects often store some variables that need to be shared, and these variables are usually stored in structured objects for easy maintenance. For example, we define shared variables in the ",(0,s.jsx)(t.code,{children:"model"})," in a context:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'const (\n    // Key name to store context variables, shared by front and back systems\n    ContextKey = "ContextKey"\n)\n\n// Request context structure\ntype Context struct {\n    Session *ghttp.Session // Current Session management object\n    User    *ContextUser   // Context user information\n    Data    g.Map          // Custom KV variables set according to business module needs, not fixed\n}\n\n// User information in the request context\ntype ContextUser struct {\n    Id       uint   // User ID\n    Passport string // User account\n    Nickname string // User name\n    Avatar   string // User avatar\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"Where:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"model.ContextKey"})," constant represents the key name stored in the ",(0,s.jsx)(t.code,{children:"context.Context"})," variable, used to store/retrieve business custom shared variables from the transmitted ",(0,s.jsx)(t.code,{children:"context.Context"})," variable."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"Session"})," in ",(0,s.jsx)(t.code,{children:"model.Context"})," structure represents the ",(0,s.jsx)(t.code,{children:"Session"})," object of the current request. In the ",(0,s.jsx)(t.code,{children:"GoFrame"})," framework, each ",(0,s.jsx)(t.code,{children:"HTTP"})," request object has an empty ",(0,s.jsx)(t.code,{children:"Session"})," object, which adopts lazy initialization design and is initialized only when real read and write operations are performed."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"User"})," in ",(0,s.jsx)(t.code,{children:"model.Context"})," structure represents the basic information of the currently logged-in user, with data available only after user login; otherwise, it is ",(0,s.jsx)(t.code,{children:"nil"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"Data"})," attribute in ",(0,s.jsx)(t.code,{children:"model.Context"})," structure is used to store custom ",(0,s.jsx)(t.code,{children:"KV"})," variables, so developers generally do not need to add custom key-value pairs to ",(0,s.jsx)(t.code,{children:"context.Context"}),", but directly use this ",(0,s.jsx)(t.code,{children:"Data"})," attribute of the ",(0,s.jsx)(t.code,{children:"model.Context"})," object. See details in later sections."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"2-logical-encapsulation",children:"2. Logical Encapsulation"}),"\n",(0,s.jsxs)(t.p,{children:["The context object is also related to business logic, so we need to encapsulate the context variables with a ",(0,s.jsx)(t.code,{children:"service"})," object for easy use by other modules."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"// Context management service\nvar Context = new(contextService)\n\ntype contextService struct{}\n\n// Initialize context object pointer into context object for subsequent request flow modifications.\nfunc (s *contextService) Init(r *ghttp.Request, customCtx *model.Context) {\n    r.SetCtxVar(model.ContextKey, customCtx)\n}\n\n// Get context variables, return nil if not set\nfunc (s *contextService) Get(ctx context.Context) *model.Context {\n    value := ctx.Value(model.ContextKey)\n    if value == nil {\n        return nil\n    }\n    if localCtx, ok := value.(*model.Context); ok {\n        return localCtx\n    }\n    return nil\n}\n\n// Set context information into context request, note it's complete overwrite\nfunc (s *contextService) SetUser(ctx context.Context, ctxUser *model.ContextUser) {\n    s.Get(ctx).User = ctxUser\n}\n"})}),"\n",(0,s.jsx)(t.h2,{id:"3-context-variable-injection",children:"3. Context Variable Injection"}),"\n",(0,s.jsxs)(t.p,{children:["Context variables must be injected into the request flow at the very beginning of the request to be available for other method calls. In ",(0,s.jsx)(t.code,{children:"HTTP"})," requests, we can achieve this with ",(0,s.jsx)(t.code,{children:"GoFrame"})," middleware. For ",(0,s.jsx)(t.code,{children:"GRPC"})," requests, interceptors can be used. We can define this in the ",(0,s.jsx)(t.code,{children:"middleware"})," management object in the ",(0,s.jsx)(t.code,{children:"service"})," layer as follows:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'// Custom context object\nfunc (s *middlewareService) Ctx(r *ghttp.Request) {\n    // Initialize, must be executed first\n    customCtx := &model.Context{\n        Session: r.Session,\n        Data:    make(g.Map),\n    }\n    service.Context.Init(r, customCtx)\n    if userEntity := Session.GetUser(r.Context()); userEntity != nil {\n        customCtx.User = &model.ContextUser{\n            Id:       userEntity.Id,\n            Passport: userEntity.Passport,\n            Nickname: userEntity.Nickname,\n            Avatar:   userEntity.Avatar,\n        }\n    }\n    // Pass the custom context object to template variables for use\n    r.Assigns(g.Map{\n        "Context": customCtx,\n    })\n    // Execute the next request logic\n    r.Middleware.Next()\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["This middleware initializes a user-executed flow shared object, and the object stored in the ",(0,s.jsx)(t.code,{children:"context.Context"})," variable is a pointer type ",(0,s.jsx)(t.code,{children:"*model.Context"}),". By fetching this pointer anywhere, you can both access and modify the data within."]}),"\n",(0,s.jsxs)(t.p,{children:["If there is stored user login information in ",(0,s.jsx)(t.code,{children:"Session"}),", the required shared user basic information will also be written into ",(0,s.jsx)(t.code,{children:"*model.Context"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"4-context-variable-usage",children:"4. Context Variable Usage"}),"\n",(0,s.jsx)(t.h3,{id:"method-definition",children:"Method Definition"}),"\n",(0,s.jsxs)(t.p,{children:["By convention, the first input parameter of a method is often reserved for ",(0,s.jsx)(t.code,{children:"context.Context"})," type parameters to accept context variables, especially in the ",(0,s.jsx)(t.code,{children:"service"})," layer methods. For example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"// Execute user login\nfunc (s *userService) Login(ctx context.Context, loginReq *define.UserServiceLoginReq) error {\n    ...\n}\n\n// Query content list\nfunc (s *contentService) GetList(ctx context.Context, r *define.ContentServiceGetListReq) (*define.ContentServiceGetListRes, error) {\n    ...\n}\n\n// Create reply content\nfunc (s *replyService) Create(ctx context.Context, r *define.ReplyServiceCreateReq) error {\n    ...\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Moreover, by convention, the last return parameter of a method is often of ",(0,s.jsx)(t.code,{children:"error"})," type. If you are sure that there will never be an ",(0,s.jsx)(t.code,{children:"error"})," inside this method, you can ignore it."]}),"\n",(0,s.jsxs)(t.h3,{id:"context-object-retrieval",children:[(0,s.jsx)(t.code,{children:"Context"})," Object Retrieval"]}),"\n",(0,s.jsxs)(t.p,{children:["Using the following method encapsulated in ",(0,s.jsx)(t.code,{children:"service"}),", you can pass the ",(0,s.jsx)(t.code,{children:"context.Context"})," variable. In the ",(0,s.jsx)(t.code,{children:"GoFrame"})," framework's ",(0,s.jsx)(t.code,{children:"HTTP"})," request, you can get the ",(0,s.jsx)(t.code,{children:"context.Context"})," variable through the ",(0,s.jsx)(t.code,{children:"r.Context()"})," method, and in ",(0,s.jsx)(t.code,{children:"GRPC"})," requests, the first parameter of the methods generated in the compiled ",(0,s.jsx)(t.code,{children:"pb"})," files is fixed as ",(0,s.jsx)(t.code,{children:"context.Context"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"service.Context.Get(ctx)\n"})}),"\n",(0,s.jsx)(t.h3,{id:"custom-key-value",children:"Custom Key-Value"}),"\n",(0,s.jsx)(t.p,{children:"Set/Get custom key-value pairs via:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"// Set custom key-value pair\nservice.Context.Get(ctx).Data[key] = value\n\n...\n\n// Get custom key-value pair\nservice.Context.Get(ctx).Data[key]\n"})}),"\n",(0,s.jsx)(t.h2,{id:"5-precautions",children:"5. Precautions"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Only pass required link parameter data in context variables, don't put everything in them. Especially for some method argument passing data, not everything should be put into them; instead, explicit parameter transmission should be used."}),"\n",(0,s.jsxs)(t.li,{children:["Context variables should only be used for temporary runtime use and not for long-term persistent storage. For example, serializing ",(0,s.jsx)(t.code,{children:"ctx"})," and storing it in a database, then deserializing it for use in the next request is incorrect."]}),"\n"]})]})}function h(e={}){let{wrapper:t}={...(0,r.a)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},250065:function(e,t,n){n.d(t,{Z:function(){return a},a:function(){return i}});var o=n(667294);let s={},r=o.createContext(s);function i(e){let t=o.useContext(r);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(r.Provider,{value:t},e.children)}}}]);