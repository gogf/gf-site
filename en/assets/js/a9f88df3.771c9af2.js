"use strict";(self.webpackChunkgf_site=self.webpackChunkgf_site||[]).push([["62155"],{167587:function(e,n,t){t.r(n),t.d(n,{metadata:()=>r,contentTitle:()=>l,default:()=>c,assets:()=>s,toc:()=>u,frontMatter:()=>o});var r=JSON.parse('{"id":"docs/\u6838\u5FC3\u7EC4\u4EF6/\u6570\u636E\u6821\u9A8C/\u6570\u636E\u6821\u9A8C-\u81EA\u5B9A\u4E49\u89C4\u5219/\u81EA\u5B9A\u4E49\u89C4\u5219-\u89C4\u5219\u6CE8\u518C","title":"Custom Rule - Registration","description":"How to perform custom rule registration and data validation under the GoFrame framework. Detailed explanation on the definition method of custom rules, parameter descriptions, and how to register global and local rules. Example code demonstrates the implementation of two common scenarios: order ID existence validation and user uniqueness validation, allowing developers to flexibly apply custom validation rule features.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/docs/\u6838\u5FC3\u7EC4\u4EF6/\u6570\u636E\u6821\u9A8C/\u6570\u636E\u6821\u9A8C-\u81EA\u5B9A\u4E49\u89C4\u5219/\u81EA\u5B9A\u4E49\u89C4\u5219-\u89C4\u5219\u6CE8\u518C.md","sourceDirName":"docs/\u6838\u5FC3\u7EC4\u4EF6/\u6570\u636E\u6821\u9A8C/\u6570\u636E\u6821\u9A8C-\u81EA\u5B9A\u4E49\u89C4\u5219","slug":"/docs/core/gvalid-custom-rules-register","permalink":"/en/docs/core/gvalid-custom-rules-register","draft":false,"unlisted":false,"editUrl":"https://github.com/gogf/gf-site/blob/main/docs/docs/\u6838\u5FC3\u7EC4\u4EF6/\u6570\u636E\u6821\u9A8C/\u6570\u636E\u6821\u9A8C-\u81EA\u5B9A\u4E49\u89C4\u5219/\u81EA\u5B9A\u4E49\u89C4\u5219-\u89C4\u5219\u6CE8\u518C.md","tags":[],"version":"current","lastUpdatedBy":"John","lastUpdatedAt":1732440306000,"sidebarPosition":0,"frontMatter":{"slug":"/docs/core/gvalid-custom-rules-register","title":"Custom Rule - Registration","sidebar_position":0,"hide_title":true,"keywords":["GoFrame","GoFrame Framework","Custom Rules","Data Validation","Rule Registration","Global Validation Rules","Local Validation Rules","i18n Feature","validation","gvalid"],"description":"How to perform custom rule registration and data validation under the GoFrame framework. Detailed explanation on the definition method of custom rules, parameter descriptions, and how to register global and local rules. Example code demonstrates the implementation of two common scenarios: order ID existence validation and user uniqueness validation, allowing developers to flexibly apply custom validation rule features."},"sidebar":"mainSidebar","previous":{"title":"Data Validation - Custom","permalink":"/en/docs/core/gvalid-custom-rules"},"next":{"title":"Custom Rule - Input Object","permalink":"/en/docs/core/gvalid-custom-rules-handle-input-parameters"}}'),i=t("785893"),a=t("250065");let o={slug:"/docs/core/gvalid-custom-rules-register",title:"Custom Rule - Registration",sidebar_position:0,hide_title:!0,keywords:["GoFrame","GoFrame Framework","Custom Rules","Data Validation","Rule Registration","Global Validation Rules","Local Validation Rules","i18n Feature","validation","gvalid"],description:"How to perform custom rule registration and data validation under the GoFrame framework. Detailed explanation on the definition method of custom rules, parameter descriptions, and how to register global and local rules. Example code demonstrates the implementation of two common scenarios: order ID existence validation and user uniqueness validation, allowing developers to flexibly apply custom validation rule features."},l=void 0,s={},u=[{value:"Relevant Data Structure",id:"relevant-data-structure",level:2},{value:"Global Validation Rule Registration",id:"global-validation-rule-registration",level:2},{value:"Example 1, Order ID Existence Validation",id:"example-1-order-id-existence-validation",level:3},{value:"Example 2, User Uniqueness Rule",id:"example-2-user-uniqueness-rule",level:3},{value:"Local Validation Rule Registration",id:"local-validation-rule-registration",level:2}];function d(e){let n={admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"relevant-data-structure",children:"Relevant Data Structure"}),"\n",(0,i.jsx)(n.p,{children:"Custom rule method definition, and the corresponding input parameter data structure."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// RuleFuncInput holds the input parameters that passed to custom rule function RuleFunc.\ntype RuleFuncInput struct {\n    // Rule specifies the validation rule string, like "required", "between:1,100", etc.\n    Rule string\n\n    // Message specifies the custom error message or configured i18n message for this rule.\n    Message string\n\n    // Value specifies the value for this rule to validate.\n    Value *gvar.Var\n\n    // Data specifies the `data` which is passed to the Validator. It might be a type of map/struct or a nil value.\n    // You can ignore the parameter `Data` if you do not really need it in your custom validation rule.\n    Data *gvar.Var\n}\n\n// RuleFunc is the custom function for data validation.\ntype RuleFunc func(ctx context.Context, in RuleFuncInput) error\n'})}),"\n",(0,i.jsx)(n.p,{children:"Brief method parameter explanation:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Context parameter ",(0,i.jsx)(n.code,{children:"ctx"})," is required."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"RuleFuncInput"})," data structure explanation:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Rule"})," indicates the current validation rule, including rule parameters, such as: ",(0,i.jsx)(n.code,{children:"required"}),", ",(0,i.jsx)(n.code,{children:"between:1,100"}),", ",(0,i.jsx)(n.code,{children:"length:6"})," etc."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Message"})," specifies the validation error message returned upon validation failure."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Value"})," specifies the data value being validated. Note that the type is a ",(0,i.jsx)(n.code,{children:"*gvar.Var"})," generic, so you can pass any type of parameter."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Data"})," specifies the parameters passed during validation, useful when validating a ",(0,i.jsx)(n.code,{children:"map"})," or ",(0,i.jsx)(n.code,{children:"struct"}),", particularly in joint validation. This value is runtime input and may be ",(0,i.jsx)(n.code,{children:"nil"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["Custom errors natively support ",(0,i.jsx)(n.code,{children:"i18n"})," features. You only need to configure i18n translation information following ",(0,i.jsx)(n.code,{children:"gf.gvalid.rule.custom_rule_name"}),". This information is automatically fetched from the i18n manager upon validation failure and passed to your registered custom validation method via the ",(0,i.jsx)(n.code,{children:"Message"})," parameter."]})}),"\n",(0,i.jsx)(n.h2,{id:"global-validation-rule-registration",children:"Global Validation Rule Registration"}),"\n",(0,i.jsx)(n.p,{children:"Custom rules are divided into two types: global rule registration and local rule registration."}),"\n",(0,i.jsx)(n.p,{children:"Global rules are rules that take effect globally. After registration, they can be used for data validation by method or object usage."}),"\n",(0,i.jsx)(n.p,{children:"Register validation method:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// RegisterRule registers custom validation rule and function for package.\nfunc RegisterRule(rule string, f RuleFunc) {\n    customRuleFuncMap[rule] = f\n}\n\n// RegisterRuleByMap registers custom validation rules using map for package.\nfunc RegisterRuleByMap(m map[string]RuleFunc) {\n    for k, v := range m {\n        customRuleFuncMap[k] = v\n    }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You need to define a validation method as per ",(0,i.jsx)(n.code,{children:"RuleFunc"})," type, implement the validation you need, and then use ",(0,i.jsx)(n.code,{children:"RegisterRule"})," to register it in the global management of the ",(0,i.jsx)(n.code,{children:"gvalid"})," module. This registration logic is generally executed during program initialization. This method will be automatically called when data validation is performed; returning ",(0,i.jsx)(n.code,{children:"nil"})," indicates validation success, otherwise, a non-empty ",(0,i.jsx)(n.code,{children:"error"})," type value should be returned."]}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsxs)(n.p,{children:["Note: The custom rule registration methods do not support concurrent calls. You need to register it during program startup (such as in the ",(0,i.jsx)(n.code,{children:"boot"})," package); dynamic registration at runtime is not possible, otherwise, it will cause concurrency safety issues."]})}),"\n",(0,i.jsx)(n.h3,{id:"example-1-order-id-existence-validation",children:"Example 1, Order ID Existence Validation"}),"\n",(0,i.jsxs)(n.p,{children:["In e-commerce business, when we perform operations on orders, we can validate whether the given order ID exists through custom rules. Therefore, we can register a global rule ",(0,i.jsx)(n.code,{children:"order-exist"})," to achieve this."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n    "context"\n    "fmt"\n    "github.com/gogf/gf/v2/database/gdb"\n    "github.com/gogf/gf/v2/errors/gerror"\n    "github.com/gogf/gf/v2/frame/g"\n    "github.com/gogf/gf/v2/os/gctx"\n    "github.com/gogf/gf/v2/util/gvalid"\n    "time"\n)\n\ntype Request struct {\n    OrderId     int64 `v:"required|order-exist"`\n    ProductName string\n    Amount      int64\n    // ...\n}\n\nfunc init() {\n    rule := "order-exist"\n    gvalid.RegisterRule(rule, RuleOrderExist)\n}\n\nfunc RuleOrderExist(ctx context.Context, in gvalid.RuleFuncInput) error {\n    // SELECT COUNT(*) FROM `order` WHERE `id` = xxx\n    count, err := g.Model("order").\n        Ctx(ctx).\n        Cache(gdb.CacheOption{\n            Duration: time.Hour,\n            Name:     "",\n            Force:    false,\n        }).\n        WhereNot("id", in.Value.Int64()).\n        Count()\n    if err != nil {\n        return err\n    }\n    if count == 0 {\n        return gerror.Newf(`invalid order id "%d"`, in.Value.Int64())\n    }\n    return nil\n}\n\nfunc main() {\n    var (\n        ctx = gctx.New()\n        req = &Request{\n            OrderId:     65535,\n            ProductName: "HikingShoe",\n            Amount:      10000,\n        }\n    )\n    err := g.Validator().CheckStruct(ctx, req)\n    fmt.Println(err)\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"example-2-user-uniqueness-rule",children:"Example 2, User Uniqueness Rule"}),"\n",(0,i.jsxs)(n.p,{children:["During user registration, we often need to check whether the submitted name/account is unique. Therefore, we can register a global rule ",(0,i.jsx)(n.code,{children:"unique-name"})," to achieve this."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n    "context"\n    "fmt"\n    "github.com/gogf/gf/v2/database/gdb"\n    "github.com/gogf/gf/v2/errors/gerror"\n    "github.com/gogf/gf/v2/frame/g"\n    "github.com/gogf/gf/v2/os/gctx"\n    "github.com/gogf/gf/v2/util/gvalid"\n    "time"\n)\n\ntype User struct {\n    Id   int\n    Name string `v:"required|unique-name#Please enter the user name|User name is already taken"`\n    Pass string `v:"required|length:6,18"`\n}\n\nfunc init() {\n    rule := "unique-name"\n    gvalid.RegisterRule(rule, RuleUniqueName)\n}\n\nfunc RuleUniqueName(ctx context.Context, in gvalid.RuleFuncInput) error {\n    var user *User\n    if err := in.Data.Scan(&user); err != nil {\n        return gerror.Wrap(err, `Scan data to user failed`)\n    }\n    // SELECT COUNT(*) FROM `user` WHERE `id` != xxx AND `name` != xxx\n    count, err := g.Model("user").\n        Ctx(ctx).\n        Cache(gdb.CacheOption{\n            Duration: time.Hour,\n            Name:     "",\n            Force:    false,\n        }).\n        WhereNot("id", user.Id).\n        WhereNot("name", user.Name).\n        Count()\n    if err != nil {\n        return err\n    }\n    if count > 0 {\n        if in.Message != "" {\n            return gerror.New(in.Message)\n        }\n        return gerror.Newf(`user name "%s" is already token by others`, user.Name)\n    }\n    return nil\n}\n\nfunc main() {\n    var (\n        ctx  = gctx.New()\n        user = &User{\n            Id:   1,\n            Name: "john",\n            Pass: "123456",\n        }\n    )\n    err := g.Validator().CheckStruct(ctx, user)\n    fmt.Println(err)\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"local-validation-rule-registration",children:"Local Validation Rule Registration"}),"\n",(0,i.jsx)(n.p,{children:"Local rules are rules that take effect only within the current validation object. Validation rules are registered into the current chain operation process being used rather than globally."}),"\n",(0,i.jsx)(n.p,{children:"Registration method:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// RuleFunc registers one custom rule function to current Validator.\nfunc (v *Validator) RuleFunc(rule string, f RuleFunc) *Validator\n\n// RuleFuncMap registers multiple custom rule functions to current Validator.\nfunc (v *Validator) RuleFuncMap(m map[string]RuleFunc) *Validator\n"})}),"\n",(0,i.jsx)(n.p,{children:"Brief introduction:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"RuleFunc"})," method is used to register a single custom validation rule to the current object."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"RuleFuncMap"})," method is used to register multiple custom validation rules to the current object."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Usage example:"}),"\n",(0,i.jsx)(n.p,{children:"We will change one of the examples above to local validation rule registration."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n    "context"\n    "fmt"\n    "github.com/gogf/gf/v2/database/gdb"\n    "github.com/gogf/gf/v2/errors/gerror"\n    "github.com/gogf/gf/v2/frame/g"\n    "github.com/gogf/gf/v2/os/gctx"\n    "github.com/gogf/gf/v2/util/gvalid"\n    "time"\n)\n\ntype Request struct {\n    OrderId     int64\n    ProductName string\n    Amount      int64\n    // ...\n}\n\nfunc RuleOrderExist(ctx context.Context, in gvalid.RuleFuncInput) error {\n    // SELECT COUNT(*) FROM `order` WHERE `id` = xxx\n    count, err := g.Model("order").\n        Ctx(ctx).\n        Cache(gdb.CacheOption{\n            Duration: time.Hour,\n            Name:     "",\n            Force:    false,\n        }).\n        WhereNot("id", in.Value.Int64()).\n        Count()\n    if err != nil {\n        return err\n    }\n    if count == 0 {\n        return gerror.Newf(`invalid order id "%d"`, in.Value.Int64())\n    }\n    return nil\n}\n\nfunc main() {\n    var (\n        ctx = gctx.New()\n        req = &Request{\n            OrderId:     65535,\n            ProductName: "HikingShoe",\n            Amount:      10000,\n        }\n    )\n    err := g.Validator().RuleFunc("order-exist", RuleOrderExist).Data(req).Run(ctx)\n    fmt.Println(err)\n}\n'})})]})}function c(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},250065:function(e,n,t){t.d(n,{Z:function(){return l},a:function(){return o}});var r=t(667294);let i={},a=r.createContext(i);function o(e){let n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);