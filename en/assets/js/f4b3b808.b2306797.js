"use strict";(self.webpackChunkgf_site=self.webpackChunkgf_site||[]).push([["40241"],{464808:function(e,n,r){r.r(n),r.d(n,{metadata:()=>t,contentTitle:()=>a,default:()=>u,assets:()=>c,toc:()=>l,frontMatter:()=>s});var t=JSON.parse('{"id":"course/starbook/\u7B2C\u4E09\u7AE0-\u4F1A\u8BDD\u7BA1\u7406/3.2.\u767B\u5F55","title":"3.2 Login","description":"The login function generates a Token upon successful verification by receiving the username and password. Using the GoFrame framework, it adheres to the development principle of Three Boards, including Api generation Controller, and writing core Logic logic. The JwtKey is used to generate the signature, and the Token is valid for six hours. The core logic is invoked in the Controller to implement the login function, and the interface is tested to ensure functionality.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/course/starbook/\u7B2C\u4E09\u7AE0-\u4F1A\u8BDD\u7BA1\u7406/3.2.\u767B\u5F55.md","sourceDirName":"course/starbook/\u7B2C\u4E09\u7AE0-\u4F1A\u8BDD\u7BA1\u7406","slug":"/course/starbook/session-login","permalink":"/en/course/starbook/session-login","draft":false,"unlisted":false,"editUrl":"https://github.com/gogf/gf-site/blob/main/docs/course/starbook/\u7B2C\u4E09\u7AE0-\u4F1A\u8BDD\u7BA1\u7406/3.2.\u767B\u5F55.md","tags":[],"version":"current","lastUpdatedBy":"oldme","lastUpdatedAt":1735822233000,"frontMatter":{"title":"3.2 Login","hide_title":true,"slug":"/course/starbook/session-login","keywords":["GoFrame","login endpoint","user authentication","generate Token","password encryption","user requests","error handling","JwtKey","interface testing","logic writing"],"description":"The login function generates a Token upon successful verification by receiving the username and password. Using the GoFrame framework, it adheres to the development principle of Three Boards, including Api generation Controller, and writing core Logic logic. The JwtKey is used to generate the signature, and the Token is valid for six hours. The core logic is invoked in the Controller to implement the login function, and the interface is tested to ensure functionality."},"sidebar":"courseStarBookSidebar","previous":{"title":"3.1 Preface","permalink":"/en/course/starbook/session-overview"},"next":{"title":"3.3 Get User Information","permalink":"/en/course/starbook/session-get-user-info"}}'),i=r("785893"),o=r("250065");let s={title:"3.2 Login",hide_title:!0,slug:"/course/starbook/session-login",keywords:["GoFrame","login endpoint","user authentication","generate Token","password encryption","user requests","error handling","JwtKey","interface testing","logic writing"],description:"The login function generates a Token upon successful verification by receiving the username and password. Using the GoFrame framework, it adheres to the development principle of Three Boards, including Api generation Controller, and writing core Logic logic. The JwtKey is used to generate the signature, and the Token is valid for six hours. The core logic is invoked in the Controller to implement the login function, and the interface is tested to ensure functionality."},a=void 0,c={},l=[{value:"Add Api",id:"add-api",level:2},{value:"Write Logic",id:"write-logic",level:2},{value:"Controller calls Logic",id:"controller-calls-logic",level:2},{value:"Interface Testing",id:"interface-testing",level:2}];function d(e){let n={blockquote:"blockquote",code:"code",em:"em",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["Upon receiving the username and password at the login endpoint, it compares them with the information in the database. If correct, it generates and returns a ",(0,i.jsx)(n.code,{children:"Token"}),', otherwise, it prompts "Username or password error."']}),"\n",(0,i.jsxs)(n.p,{children:["Similarly, it follows the development principle of Three Boards: writing ",(0,i.jsx)(n.code,{children:"Api"})," to generate ",(0,i.jsx)(n.code,{children:"Controller"}),", writing core logic ",(0,i.jsx)(n.code,{children:"Logic"}),", and having the ",(0,i.jsx)(n.code,{children:"Controller"})," call ",(0,i.jsx)(n.code,{children:"Logic"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"add-api",children:"Add Api"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"api/users/v1/users.go"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'...\n  \ntype LoginReq struct {  \n    g.Meta   `path:"users/login" method:"post" sm:"Login" tags:"User"`  \n    Username string `json:"username" v:"required|length:3,12"`  \n    Password string `json:"password" v:"required|length:6,16"`  \n}  \n  \ntype LoginRes struct {  \n    Token string `json:"token" dc:"Add Authorization: token in the header for authentication-required interfaces"`\n}\n'})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["Don't forget to execute ",(0,i.jsx)(n.code,{children:"gf gen ctrl"}),"! You need to execute it every time you change the ",(0,i.jsx)(n.code,{children:"Api"}),", not repeated in the text below."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"write-logic",children:"Write Logic"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:["The difficulty of the login logic lies in generating the ",(0,i.jsx)(n.code,{children:"Token"}),". Prepare a random string ",(0,i.jsx)(n.code,{children:"JwtKey"})," as the signature, and define it in the ",(0,i.jsx)(n.code,{children:"utility"})," directory."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"utility/jwt.go"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package utility  \n  \nvar JwtKey = []byte("db03d23b03ec405793b38f10592a2f34")\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Write the core logic. First, perform a ",(0,i.jsx)(n.code,{children:"Where"})," query based on the username. After data retrieval, encrypt the password again. If it matches the encrypted text in the database, it's a legitimate user and a ",(0,i.jsx)(n.code,{children:"Token"})," is generated and returned."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"internal/logic/users/account.go"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package users  \n  \nimport (  \n    "context"  \n    "errors"\n    "time"  \n    \n    "github.com/golang-jwt/jwt/v5"\n    \n    "star/internal/dao"    \n    "star/internal/model/entity"    \n    "star/utility"\n)\n  \ntype userClaims struct {  \n    Id       uint  \n    Username string  \n    jwt.RegisteredClaims  \n}  \n  \nfunc (u *Users) Login(ctx context.Context, username, password string) (tokenString string, err error) {  \n    var user entity.Users  \n    err = dao.Users.Ctx(ctx).Where("username", username).Scan(&user)  \n    if err != nil {  \n       return "", errors.New("Username or password error")  \n    }  \n  \n    if user.Id == 0 {  \n       return "", errors.New("User does not exist")  \n    }  \n  \n    // Encrypt the password and compare it with the password in the database  \n    if user.Password != encryptPassword(password) {  \n       return "", errors.New("Username or password error")  \n    }  \n  \n    // Generate token  \n	uc := &userClaims{  \n       Id:       user.Id,  \n       Username: user.Username,  \n       RegisteredClaims: jwt.RegisteredClaims{  \n          ExpiresAt: jwt.NewNumericDate(time.Now().Add(6 * time.Hour)),  \n       },  \n    }  \n    token := jwt.NewWithClaims(jwt.SigningMethodHS256, uc)  \n    return token.SignedString(utility.JwtKey)  \n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["As seen in the above code, we need to declare a struct ",(0,i.jsx)(n.code,{children:"UserClaims"})," to store the signature information. It saves the ",(0,i.jsx)(n.code,{children:"Id"})," and ",(0,i.jsx)(n.code,{children:"Username"})," and sets the token validity to 6 hours. The final declared object needs to call the ",(0,i.jsx)(n.code,{children:"SignedString"})," method and pass in ",(0,i.jsx)(n.code,{children:"JwtKey"})," to generate a signature."]}),"\n",(0,i.jsx)(n.h2,{id:"controller-calls-logic",children:"Controller calls Logic"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"internal/controller/users/users_v1_login.go"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package users  \n  \nimport (  \n    "context"  \n    \n    "star/internal/logic/users"  \n    "star/api/users/v1"\n)  \n  \nfunc (c *ControllerV1) Login(ctx context.Context, req *v1.LoginReq) (res *v1.LoginRes, err error) {  \n    token, err := c.users.Login(ctx, req.Username, req.Password)  \n    if err != nil {  \n       return  \n    }  \n    return &v1.LoginRes{Token: token}, nil  \n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"interface-testing",children:"Interface Testing"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'$ curl -X POST http://127.0.0.1:8000/v1/users/login -H "Content-Type: application/json" -d "{\\"username\\":\\"oldme\\", \\"password\\":\\"123456\\"}"\n\n{\n    "code":0,\n    "message":"",\n    "data":{\n        "token":"eyJhbGciOi...ZY_ATzOU"\n    }\n}\n'})})]})}function u(e={}){let{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},250065:function(e,n,r){r.d(n,{Z:function(){return a},a:function(){return s}});var t=r(667294);let i={},o=t.createContext(i);function s(e){let n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);