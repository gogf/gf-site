"use strict";(self.webpackChunkgf_site=self.webpackChunkgf_site||[]).push([["13549"],{225511:function(e,n,o){o.r(n),o.d(n,{metadata:()=>t,contentTitle:()=>i,default:()=>g,assets:()=>a,toc:()=>l,frontMatter:()=>c});var t=JSON.parse('{"id":"docs/\u7EC4\u4EF6\u5217\u8868/\u7F51\u7EDC\u7EC4\u4EF6/TCP\u7EC4\u4EF6/TCP\u7EC4\u4EF6-\u8FDE\u63A5\u5BF9\u8C61/\u8FDE\u63A5\u5BF9\u8C61-\u901A\u4FE1\u5F00\u53D1\u8FDB\u9636","title":"TCP Object - Senior","description":"Advanced development of asynchronous full-duplex communication using gtcp in the GoFrame framework. The complete example demonstrates how to handle long connections in a program, use SendPkg and RecvPkg methods for data transmission, and ensure concurrency safety.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/docs/\u7EC4\u4EF6\u5217\u8868/\u7F51\u7EDC\u7EC4\u4EF6/TCP\u7EC4\u4EF6/TCP\u7EC4\u4EF6-\u8FDE\u63A5\u5BF9\u8C61/\u8FDE\u63A5\u5BF9\u8C61-\u901A\u4FE1\u5F00\u53D1\u8FDB\u9636.md","sourceDirName":"docs/\u7EC4\u4EF6\u5217\u8868/\u7F51\u7EDC\u7EC4\u4EF6/TCP\u7EC4\u4EF6/TCP\u7EC4\u4EF6-\u8FDE\u63A5\u5BF9\u8C61","slug":"/docs/components/network-gtcp-conn-senior","permalink":"/en/docs/components/network-gtcp-conn-senior","draft":false,"unlisted":false,"editUrl":"https://github.com/gogf/gf-site/blob/main/docs/docs/\u7EC4\u4EF6\u5217\u8868/\u7F51\u7EDC\u7EC4\u4EF6/TCP\u7EC4\u4EF6/TCP\u7EC4\u4EF6-\u8FDE\u63A5\u5BF9\u8C61/\u8FDE\u63A5\u5BF9\u8C61-\u901A\u4FE1\u5F00\u53D1\u8FDB\u9636.md","tags":[],"version":"current","lastUpdatedBy":"John","lastUpdatedAt":1740621099000,"sidebarPosition":1,"frontMatter":{"slug":"/docs/components/network-gtcp-conn-senior","title":"TCP Object - Senior","sidebar_position":1,"hide_title":true,"keywords":["GoFrame","GoFrame Framework","gtcp","Long Connection","Asynchronous Communication","Full Duplex Communication","SendPkg","RecvPkg","Network Programming","Concurrency Safety"],"description":"Advanced development of asynchronous full-duplex communication using gtcp in the GoFrame framework. The complete example demonstrates how to handle long connections in a program, use SendPkg and RecvPkg methods for data transmission, and ensure concurrency safety."},"sidebar":"mainSidebar","previous":{"title":"TCP Object - Package","permalink":"/en/docs/components/network-gtcp-conn-package"},"next":{"title":"TCP - Methods","permalink":"/en/docs/components/network-gtcp-funcs"}}'),s=o("785893"),r=o("250065");let c={slug:"/docs/components/network-gtcp-conn-senior",title:"TCP Object - Senior",sidebar_position:1,hide_title:!0,keywords:["GoFrame","GoFrame Framework","gtcp","Long Connection","Asynchronous Communication","Full Duplex Communication","SendPkg","RecvPkg","Network Programming","Concurrency Safety"],description:"Advanced development of asynchronous full-duplex communication using gtcp in the GoFrame framework. The complete example demonstrates how to handle long connections in a program, use SendPkg and RecvPkg methods for data transmission, and ensure concurrency safety."},i=void 0,a={},l=[{value:"Advanced Development",id:"advanced-development",level:2},{value:"Example",id:"example",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"advanced-development",children:"Advanced Development"}),"\n",(0,s.jsxs)(n.p,{children:["For short connections, each data send and receive operation closes the connection, resulting in relatively simple connection handling logic but lower communication efficiency. In most TCP communication scenarios, long connection operations are often used, with an asynchronous full-duplex TCP communication mode, meaning all communication is entirely asynchronous. In such scenarios, the ",(0,s.jsx)(n.code,{children:"gtcp.Conn"})," link object may simultaneously be in multiple read and write operations (data read and write operations of the ",(0,s.jsx)(n.code,{children:"gtcp.Conn"})," object are concurrency-safe), hence ",(0,s.jsx)(n.code,{children:"SendRecv"})," operations will logically fail. Because after sending data in the same logical operation, immediately retrieving data might result in receiving results from other write operations."]}),"\n",(0,s.jsxs)(n.p,{children:["Both the server and client need to encapsulate the use of the ",(0,s.jsx)(n.code,{children:"Recv*"})," method to obtain data in an independent asynchronous loop and handle data through ",(0,s.jsx)(n.code,{children:"switch...case..."})," (fully responsible for reading data in one ",(0,s.jsx)(n.code,{children:"goroutine"}),"), forwarding business processing based on the request data."]}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["That is, ",(0,s.jsx)(n.code,{children:"Send*"}),"/",(0,s.jsx)(n.code,{children:"Recv*"})," methods are concurrency-safe, but data should be sent in one go. Because asynchronous concurrent writing is supported, the ",(0,s.jsx)(n.code,{children:"gtcp.Conn"})," object is implemented without any buffering."]})}),"\n",(0,s.jsx)(n.h2,{id:"example",children:"Example"}),"\n",(0,s.jsxs)(n.p,{children:["We'll illustrate how to implement asynchronous full-duplex communication in a program with a complete example, found at: ",(0,s.jsx)(n.a,{href:"https://github.com/gogf/gf/tree/master/.example/net/gtcp/pkg_operations/common",children:"https://github.com/gogf/gf/tree/master/.example/net/gtcp/pkg_operations/common"})]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"types/types.go"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Define the data format for communication so we can use ",(0,s.jsx)(n.code,{children:"SendPkg"}),"/",(0,s.jsx)(n.code,{children:"RecvPkg"})," methods for communication."]}),"\n",(0,s.jsxs)(n.p,{children:["For simplification of test code complexity, we'll use the ",(0,s.jsx)(n.code,{children:"JSON"})," data format to pass data here. In some scenarios where the message package size is strictly considered, the ",(0,s.jsx)(n.code,{children:"Data"})," field can be encapsulated and parsed in binary as needed. Also, note that even using ",(0,s.jsx)(n.code,{children:"JSON"})," data format, the ",(0,s.jsx)(n.code,{children:"Act"})," field often defines constants for implementation, and ",(0,s.jsx)(n.code,{children:"uint8"})," type suffices for most cases to reduce message package size. Here, we use strings for demonstration purposes."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"package types\n\n\ntype Msg struct {\n       Act  string // Operation\n       Data string // Data\n}\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"funcs/funcs.go"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Custom definitions for sending/receiving data in defined formats, facilitating data structure encoding/parsing."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'package funcs\n\n\nimport (\n       "encoding/json"\n       "fmt"\n       "github.com/gogf/gf/v2/net/gtcp"\n       "github.com/gogf/gf/.example/net/gtcp/pkg_operations/common/types"\n)\n\n\n// Custom format message package sending\nfunc SendPkg(conn *gtcp.Conn, act string, data...string) error {\n       s := ""\n       if len(data) > 0 {\n           s = data[0]\n       }\n       msg, err := json.Marshal(types.Msg{\n           Act  : act,\n           Data : s,\n       })\n       if err != nil {\n           panic(err)\n       }\n       return conn.SendPkg(msg)\n}\n\n\n// Custom format message package receiving\nfunc RecvPkg(conn *gtcp.Conn) (msg *types.Msg, err error) {\n       if data, err := conn.RecvPkg(); err != nil {\n           return nil, err\n       } else {\n           msg = &types.Msg{}\n           err = json.Unmarshal(data, msg)\n           if err != nil {\n               return nil, fmt.Errorf("invalid package structure: %s", err.Error())\n           }\n           return msg, err\n       }\n}\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"gtcp_common_server.go"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Communication server. In this example, the server does not actively disconnect, but sends a ",(0,s.jsx)(n.code,{children:"doexit"})," message to the client after ",(0,s.jsx)(n.code,{children:"10"})," seconds, notifying the client to disconnect to end the example."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'package main\n\n\nimport (\n       "github.com/gogf/gf/v2/net/gtcp"\n       "github.com/gogf/gf/v2/os/glog"\n       "github.com/gogf/gf/v2/os/gtimer"\n       "github.com/gogf/gf/.example/net/gtcp/pkg_operations/common/funcs"\n       "github.com/gogf/gf/.example/net/gtcp/pkg_operations/common/types"\n       "time"\n)\n\n\nfunc main() {\n       gtcp.NewServer("127.0.0.1:8999", func(conn *gtcp.Conn) {\n           defer conn.Close()\n           // Test message, let the client exit voluntarily after 10 seconds\n           gtimer.SetTimeout(10*time.Second, func() {\n               funcs.SendPkg(conn, "doexit")\n           })\n           for {\n               msg, err := funcs.RecvPkg(conn)\n               if err != nil {\n                   if err.Error() == "EOF" {\n                       glog.Println("client closed")\n                   }\n                   break\n               }\n               switch msg.Act {\n                   case "hello":     onClientHello(conn, msg)\n                   case "heartbeat": onClientHeartBeat(conn, msg)\n                   default:\n                       glog.Errorf("invalid message: %v", msg)\n                       break\n               }\n           }\n       }).Run()\n}\n\n\nfunc onClientHello(conn *gtcp.Conn, msg *types.Msg) {\n       glog.Printf("hello message from [%s]: %s", conn.RemoteAddr().String(), msg.Data)\n       funcs.SendPkg(conn, msg.Act, "Nice to meet you!")\n}\n\n\nfunc onClientHeartBeat(conn *gtcp.Conn, msg *types.Msg) {\n       glog.Printf("heartbeat from [%s]", conn.RemoteAddr().String())\n}\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"gtcp_common_client.go"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Communication client. As you can see, the code structure is similar to the server, with data retrieval independently residing within a ",(0,s.jsx)(n.code,{children:"for"})," loop. Each business logic sends message packages directly using the ",(0,s.jsx)(n.code,{children:"SendPkg"})," method."]}),"\n",(0,s.jsxs)(n.p,{children:["Heartbeat messages are typically implemented with a ",(0,s.jsx)(n.code,{children:"gtimer"})," timer. In this example, the client sends heartbeat messages to the server every ",(0,s.jsx)(n.code,{children:"1"})," second and sends a ",(0,s.jsx)(n.code,{children:"hello"})," test message to the server after ",(0,s.jsx)(n.code,{children:"3"})," seconds. These are implemented using the ",(0,s.jsx)(n.code,{children:"gtimer"})," timer, which is common in TCP communication."]}),"\n",(0,s.jsxs)(n.p,{children:["After ",(0,s.jsx)(n.code,{children:"10"})," seconds of client connection, the server sends a ",(0,s.jsx)(n.code,{children:"doexit"})," message to the client, prompting the client to disconnect, ending the long connection."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'package main\n\n\nimport (\n       "github.com/gogf/gf/v2/net/gtcp"\n       "github.com/gogf/gf/v2/os/glog"\n       "github.com/gogf/gf/v2/os/gtimer"\n       "github.com/gogf/gf/.example/net/gtcp/pkg_operations/common/funcs"\n       "github.com/gogf/gf/.example/net/gtcp/pkg_operations/common/types"\n       "time"\n)\n\n\nfunc main() {\n       conn, err := gtcp.NewConn("127.0.0.1:8999")\n       if err != nil {\n           panic(err)\n       }\n       defer conn.Close()\n       // Heartbeat message\n       gtimer.SetInterval(time.Second, func() {\n           if err := funcs.SendPkg(conn, "heartbeat"); err != nil {\n               panic(err)\n           }\n       })\n       // Test message, send hello message to server after 3 seconds\n       gtimer.SetTimeout(3*time.Second, func() {\n           if err := funcs.SendPkg(conn, "hello", "My name\'s John!"); err != nil {\n               panic(err)\n           }\n       })\n       for {\n           msg, err := funcs.RecvPkg(conn)\n           if err != nil {\n               if err.Error() == "EOF" {\n                   glog.Println("server closed")\n               }\n               break\n           }\n           switch msg.Act {\n               case "hello":     onServerHello(conn, msg)\n               case "doexit":    onServerDoExit(conn, msg)\n               case "heartbeat": onServerHeartBeat(conn, msg)\n               default:\n                   glog.Errorf("invalid message: %v", msg)\n                   break\n           }\n       }\n}\n\n\nfunc onServerHello(conn *gtcp.Conn, msg *types.Msg) {\n       glog.Printf("hello response message from [%s]: %s", conn.RemoteAddr().String(), msg.Data)\n}\n\n\nfunc onServerHeartBeat(conn *gtcp.Conn, msg *types.Msg) {\n       glog.Printf("heartbeat from [%s]", conn.RemoteAddr().String())\n}\n\n\nfunc onServerDoExit(conn *gtcp.Conn, msg *types.Msg) {\n       glog.Printf("exit command from [%s]", conn.RemoteAddr().String())\n       conn.Close()\n}\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"After execution"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Server output result"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:"  2019-05-03 14:59:13.732 heartbeat from [127.0.0.1:51220]\n  2019-05-03 14:59:14.732 heartbeat from [127.0.0.1:51220]\n  2019-05-03 14:59:15.733 heartbeat from [127.0.0.1:51220]\n  2019-05-03 14:59:15.733 hello message from [127.0.0.1:51220]: My name's John!\n  2019-05-03 14:59:16.731 heartbeat from [127.0.0.1:51220]\n  2019-05-03 14:59:17.733 heartbeat from [127.0.0.1:51220]\n  2019-05-03 14:59:18.731 heartbeat from [127.0.0.1:51220]\n  2019-05-03 14:59:19.730 heartbeat from [127.0.0.1:51220]\n  2019-05-03 14:59:20.732 heartbeat from [127.0.0.1:51220]\n  2019-05-03 14:59:21.732 heartbeat from [127.0.0.1:51220]\n  2019-05-03 14:59:22.698 client closed\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Client output result"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-html",children:"  2019-05-03 14:59:15.733 hello response message from [127.0.0.1:8999]: Nice to meet you!\n  2019-05-03 14:59:22.698 exit command from [127.0.0.1:8999]\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]})]})}function g(e={}){let{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},250065:function(e,n,o){o.d(n,{Z:function(){return i},a:function(){return c}});var t=o(667294);let s={},r=t.createContext(s);function c(e){let n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);