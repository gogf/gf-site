"use strict";(self.webpackChunkgf_site=self.webpackChunkgf_site||[]).push([["13604"],{770415:function(e,n,t){t.r(n),t.d(n,{metadata:()=>o,contentTitle:()=>s,default:()=>g,assets:()=>c,toc:()=>l,frontMatter:()=>r});var o=JSON.parse('{"id":"docs/\u7EC4\u4EF6\u5217\u8868/\u7F51\u7EDC\u7EC4\u4EF6/TCP\u7EC4\u4EF6/TCP\u7EC4\u4EF6-\u8FDE\u63A5\u5BF9\u8C61/\u8FDE\u63A5\u5BF9\u8C61-\u6D88\u606F\u5305\u5904\u7406","title":"TCP Object - Package","description":"Solve the TCP message protocol\'s sticky packet problem using the gtcp module and its packaging and unpacking features. By using GoFrame\'s simple lightweight data interaction protocol, developers can more easily engage in message package interaction without worrying about the complexities of packaging and unpacking. Additionally, the documentation provides several examples to help developers better understand and implement message transmission with custom data structures.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/docs/\u7EC4\u4EF6\u5217\u8868/\u7F51\u7EDC\u7EC4\u4EF6/TCP\u7EC4\u4EF6/TCP\u7EC4\u4EF6-\u8FDE\u63A5\u5BF9\u8C61/\u8FDE\u63A5\u5BF9\u8C61-\u6D88\u606F\u5305\u5904\u7406.md","sourceDirName":"docs/\u7EC4\u4EF6\u5217\u8868/\u7F51\u7EDC\u7EC4\u4EF6/TCP\u7EC4\u4EF6/TCP\u7EC4\u4EF6-\u8FDE\u63A5\u5BF9\u8C61","slug":"/docs/components/network-gtcp-conn-package","permalink":"/en/docs/components/network-gtcp-conn-package","draft":false,"unlisted":false,"editUrl":"https://github.com/gogf/gf-site/blob/main/docs/docs/\u7EC4\u4EF6\u5217\u8868/\u7F51\u7EDC\u7EC4\u4EF6/TCP\u7EC4\u4EF6/TCP\u7EC4\u4EF6-\u8FDE\u63A5\u5BF9\u8C61/\u8FDE\u63A5\u5BF9\u8C61-\u6D88\u606F\u5305\u5904\u7406.md","tags":[],"version":"current","lastUpdatedBy":"John","lastUpdatedAt":1732443619000,"sidebarPosition":0,"frontMatter":{"slug":"/docs/components/network-gtcp-conn-package","title":"TCP Object - Package","sidebar_position":0,"hide_title":true,"keywords":["TCP","Sticky Packet","gtcp","GoFrame","Data Protocol","Pack and Unpack","Message Package","Network Communication","Simple Protocol","Message Interaction"],"description":"Solve the TCP message protocol\'s sticky packet problem using the gtcp module and its packaging and unpacking features. By using GoFrame\'s simple lightweight data interaction protocol, developers can more easily engage in message package interaction without worrying about the complexities of packaging and unpacking. Additionally, the documentation provides several examples to help developers better understand and implement message transmission with custom data structures."},"sidebar":"mainSidebar","previous":{"title":"TCP - Object","permalink":"/en/docs/components/network-gtcp-conn"},"next":{"title":"TCP Object - Senior","permalink":"/en/docs/components/network-gtcp-conn-senior"}}'),i=t("785893"),a=t("250065");let r={slug:"/docs/components/network-gtcp-conn-package",title:"TCP Object - Package",sidebar_position:0,hide_title:!0,keywords:["TCP","Sticky Packet","gtcp","GoFrame","Data Protocol","Pack and Unpack","Message Package","Network Communication","Simple Protocol","Message Interaction"],description:"Solve the TCP message protocol's sticky packet problem using the gtcp module and its packaging and unpacking features. By using GoFrame's simple lightweight data interaction protocol, developers can more easily engage in message package interaction without worrying about the complexities of packaging and unpacking. Additionally, the documentation provides several examples to help developers better understand and implement message transmission with custom data structures."},s=void 0,c={},l=[{value:"Simple Protocol",id:"simple-protocol",level:2},{value:"Operation Methods",id:"operation-methods",level:2},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Example 1, Basic Usage",id:"example-1-basic-usage",level:3},{value:"Example 2, Custom Data Structure",id:"example-2-custom-data-structure",level:3}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"gtcp"})," provides many convenient native methods for connecting and operating data. However, in most application scenarios, developers need to design their own data structures and perform packaging/unpacking. Since the ",(0,i.jsx)(n.code,{children:"TCP"})," message protocol does not have message boundary protection, sticky packets can easily occur in complex network communication environments. Therefore, ",(0,i.jsx)(n.code,{children:"gtcp"})," also provides a simple data protocol, making it easy for developers to interact with message packages without worrying about processing details, including packaging/unpacking, as all these complex logics have been handled by ",(0,i.jsx)(n.code,{children:"gtcp"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"simple-protocol",children:"Simple Protocol"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"gtcp"})," module offers a simple, lightweight data interaction protocol with high efficiency. The protocol format is as follows:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Data Length (16bit) | Data Field (variable length)\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Data Length: Default is ",(0,i.jsx)(n.code,{children:"16-bit"})," (",(0,i.jsx)(n.code,{children:"2 bytes"}),"), used to identify the data length of the message body in bytes, not including its own 2 bytes;"]}),"\n",(0,i.jsxs)(n.li,{children:["Data Field: Variable length. With data length, the maximum data length cannot exceed ",(0,i.jsx)(n.code,{children:"0xFFFF = 65535 bytes = 64 KB"}),";"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The simple protocol is implemented by ",(0,i.jsx)(n.code,{children:"gtcp"}),". If both the client's and server's developers use the ",(0,i.jsx)(n.code,{children:"gtcp"})," module for communication, then there is no need to worry about protocol implementation, and they can focus on implementing/enclosing the ",(0,i.jsx)(n.code,{children:"Data"})," field. If interfacing with other development languages is involved, it only requires implementation according to this protocol, as the simple protocol is very lightweight, leading to low interfacing costs."]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"The Data field can also be empty, meaning no length at all."})}),"\n",(0,i.jsx)(n.h2,{id:"operation-methods",children:"Operation Methods"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://pkg.go.dev/github.com/gogf/gf/v2/net/gtcp",children:"https://pkg.go.dev/github.com/gogf/gf/v2/net/gtcp"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Conn\n    func (c *Conn) SendPkg(data []byte, option ...PkgOption) error\n    func (c *Conn) SendPkgWithTimeout(data []byte, timeout time.Duration, option ...PkgOption) error\n    func (c *Conn) SendRecvPkg(data []byte, option ...PkgOption) ([]byte, error)\n    func (c *Conn) SendRecvPkgWithTimeout(data []byte, timeout time.Duration, option ...PkgOption) ([]byte, error)\n    func (c *Conn) RecvPkg(option ...PkgOption) (result []byte, err error)\n    func (c *Conn) RecvPkgWithTimeout(timeout time.Duration, option ...PkgOption) ([]byte, error)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["As seen, the message package methods are named by adding the ",(0,i.jsx)(n.code,{children:"Pkg"})," keyword to the original basic connection operation methods for easy distinction."]}),"\n",(0,i.jsxs)(n.p,{children:["Among them, the ",(0,i.jsx)(n.code,{children:"PkgOption"})," data structure in the request parameter is as follows, used to define the message package receiving strategy:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// Data reading options\ntype PkgOption struct {\n    HeaderSize  int   // Custom header size (default is 2 bytes, maximum cannot exceed 4 bytes)\n    MaxDataSize int   // (byte) Maximum package size for data reading, default maximum cannot exceed 2 bytes (65535 byte)\n    Retry       Retry // Failure retry policy\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,i.jsx)(n.h3,{id:"example-1-basic-usage",children:"Example 1, Basic Usage"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n    "fmt"\n    "github.com/gogf/gf/v2/net/gtcp"\n    "github.com/gogf/gf/v2/os/glog"\n    "github.com/gogf/gf/v2/util/gconv"\n    "time"\n)\n\nfunc main() {\n    // Server\n    go gtcp.NewServer("127.0.0.1:8999", func(conn *gtcp.Conn) {\n        defer conn.Close()\n        for {\n            data, err := conn.RecvPkg()\n            if err != nil {\n                fmt.Println(err)\n                break\n            }\n            fmt.Println("receive:", data)\n        }\n    }).Run()\n\n    time.Sleep(time.Second)\n\n    // Client\n    conn, err := gtcp.NewConn("127.0.0.1:8999")\n    if err != nil {\n        panic(err)\n    }\n    defer conn.Close()\n    for i := 0; i < 10000; i++ {\n        if err := conn.SendPkg([]byte(gconv.String(i))); err != nil {\n            glog.Error(err)\n        }\n        time.Sleep(1*time.Second)\n    }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"This example is quite simple. After execution, the output result is:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"receive: [48]\nreceive: [49]\nreceive: [50]\nreceive: [51]\n...\n"})}),"\n",(0,i.jsx)(n.h3,{id:"example-2-custom-data-structure",children:"Example 2, Custom Data Structure"}),"\n",(0,i.jsxs)(n.p,{children:["In most scenarios, we need to customize the data structure for the messages sent. Developers can use the ",(0,i.jsx)(n.code,{children:"Data"})," field to transmit any message content."]}),"\n",(0,i.jsxs)(n.p,{children:["Below is a simple example of a custom data structure for a client to report the current memory and CPU usage of the host node. In this example, the ",(0,i.jsx)(n.code,{children:"Data"})," field uses ",(0,i.jsx)(n.code,{children:"JSON"})," data format for customization, making data encoding/decoding easier."]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["In practical scenarios, developers often need to customize package parsing protocols or adopt more general ",(0,i.jsx)(n.code,{children:"protobuf"})," binary package encapsulation/parsing protocols."]})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"types/types.go"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Data structure definition."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package types\n\nimport "github.com/gogf/gf/v2/frame/g"\n\ntype NodeInfo struct {\n       Cpu       float32 // CPU percentage (%)\n       Host      string  // Host name\n       Ip        g.Map   // IP address information (possibly multiple)\n       MemUsed   int     // Memory used (byte)\n       MemTotal  int     // Total memory (byte)\n       Time      int     // Reporting time (timestamp)\n}\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"gtcp_monitor_server.go"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Server."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n       "encoding/json"\n       "github.com/gogf/gf/v2/net/gtcp"\n       "github.com/gogf/gf/v2/os/glog"\n       "github.com/gogf/gf/.example/net/gtcp/pkg_operations/monitor/types"\n)\n\nfunc main() {\n       // Server, receive client data and format it into a specified data structure, print\n       gtcp.NewServer("127.0.0.1:8999", func(conn *gtcp.Conn) {\n           defer conn.Close()\n           for {\n               data, err := conn.RecvPkg()\n               if err != nil {\n                   if err.Error() == "EOF" {\n                       glog.Println("client closed")\n                   }\n                   break\n               }\n               info := &types.NodeInfo{}\n               if err := json.Unmarshal(data, info); err != nil {\n                   glog.Errorf("invalid package structure: %s", err.Error())\n               } else {\n                   glog.Println(info)\n                   conn.SendPkg([]byte("ok"))\n               }\n           }\n       }).Run()\n}\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"gtcp_monitor_client.go"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Client."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n       "encoding/json"\n       "github.com/gogf/gf/v2/frame/g"\n       "github.com/gogf/gf/v2/net/gtcp"\n       "github.com/gogf/gf/v2/os/glog"\n       "github.com/gogf/gf/v2/os/gtime"\n       "github.com/gogf/gf/.example/net/gtcp/pkg_operations/monitor/types"\n)\n\nfunc main() {\n       // Data reporting client\n       conn, err := gtcp.NewConn("127.0.0.1:8999")\n       if err != nil {\n           panic(err)\n       }\n       defer conn.Close()\n       // Format data fields using JSON\n       info, err := json.Marshal(types.NodeInfo{\n           Cpu       : float32(66.66),\n           Host      : "localhost",\n           Ip        : g.Map {\n               "etho" : "192.168.1.100",\n               "eth1" : "114.114.10.11",\n           },\n           MemUsed   : 15560320,\n           MemTotal  : 16333788,\n           Time      : int(gtime.Timestamp()),\n       })\n       if err != nil {\n           panic(err)\n       }\n       // Use SendRecvPkg to send a message package and receive return\n       if result, err := conn.SendRecvPkg(info); err != nil {\n           if err.Error() == "EOF" {\n               glog.Println("server closed")\n           }\n       } else {\n           glog.Println(string(result))\n       }\n}\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"After execution"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"The client output result is:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:"  2019-05-03 13:33:25.710 ok\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"The server output result is:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:"  2019-05-03 13:33:25.710 &{66.66 localhost map[eth1:114.114.10.11 etho:192.168.1.100] 15560320 16333788 1556861605}\n  2019-05-03 13:33:25.710 client closed\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]})]})}function g(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},250065:function(e,n,t){t.d(n,{Z:function(){return s},a:function(){return r}});var o=t(667294);let i={},a=o.createContext(i);function r(e){let n=o.useContext(a);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(a.Provider,{value:n},e.children)}}}]);