<!doctype html><html lang=zh-Hans dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-community/社区投稿/打造高性能实时通信：Go语言SSE实现指南" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>打造高性能实时通信：Go语言SSE实现指南 | GoFrame官网 - 类似PHP-Laravel,Java-SpringBoot的Go语言开发框架</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://goframe.org/articles/go-sse-implementation-guide><meta data-rh=true property=og:locale content=zh_Hans><meta data-rh=true property=og:locale:alternate content=en_US><meta data-rh=true name=docusaurus_locale content=zh-Hans><meta data-rh=true name=docsearch:language content=zh-Hans><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="打造高性能实时通信：Go语言SSE实现指南 | GoFrame官网 - 类似PHP-Laravel,Java-SpringBoot的Go语言开发框架"><meta data-rh=true name=description content=使用Go语言实现高性能实时通信的最佳实践，详细剖析SSE技术的原理、应用场景及AI领域的实践。从基础实现到分布式架构，覆盖单客户端消息发送、广播消息、Redis集成以及多协程并发处理等核心技术，并提供完整代码示例和性能优化策略。><meta data-rh=true property=og:description content=使用Go语言实现高性能实时通信的最佳实践，详细剖析SSE技术的原理、应用场景及AI领域的实践。从基础实现到分布式架构，覆盖单客户端消息发送、广播消息、Redis集成以及多协程并发处理等核心技术，并提供完整代码示例和性能优化策略。><meta data-rh=true name=keywords content="Go,SSE,Server-Sent Events,实时通信,AI流式输出,分布式消息,Redis发布订阅,客户端推送,实时数据更新,并发处理"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://goframe.org/articles/go-sse-implementation-guide><link data-rh=true rel=alternate href=https://goframe.org/articles/go-sse-implementation-guide hreflang=zh-Hans><link data-rh=true rel=alternate href=https://goframe.org/en/articles/go-sse-implementation-guide hreflang=en-US><link data-rh=true rel=alternate href=https://goframe.org/articles/go-sse-implementation-guide hreflang=x-default><link data-rh=true rel=preconnect href=https://ZQUL8VI47R-dsn.algolia.net crossorigin><link rel=search type=application/opensearchdescription+xml title="GoFrame官网 - 类似PHP-Laravel,Java-SpringBoot的Go语言开发框架" href=/opensearch.xml><script src=https://hm.baidu.com/hm.js?38f38a0626fd7805722db06243cd0fa7 async></script><link rel=stylesheet href=/assets/css/styles.9d64870a.css><script src=/assets/js/main.a20eaf23.js defer></script><script src=/assets/js/runtime~main.f6d54ee0.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label=跳到主要内容><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>跳到主要内容</a></div><nav aria-label=主导航 class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label=切换导航栏 aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/logo2.png alt="GoFrame Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/logo2.png alt="GoFrame Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" sidebarid=quickSidebar href=/quick/install>快速开始</a><a class="navbar__item navbar__link" sidebarid=mainSidebar href=/docs/core>开发手册</a><div class="navbar__item dropdown dropdown--hoverable"><a class=navbar__link aria-haspopup=true aria-expanded=false role=button sidebarid=courseSidebar href=/course>社区教程</a><ul class=dropdown__menu><li><a class=dropdown__link sidebarid=courseSidebar href=/course/bilibili-video>视频入门教程</a><li><a class=dropdown__link sidebarid=courseStarBookSidebar href=/course/starbook>入门实战教程-星辰英语本</a><li><a class=dropdown__link sidebarid=courseProximaBookSidebar href=/course/proxima-book>微服务实战教程-比邻英语本</a></ul></div><a class="navbar__item navbar__link" href=/examples/grpc>代码示例</a><a class="navbar__item navbar__link" href=/showcase>案例展示</a><a class="navbar__item navbar__link" href=/release/note>发布记录</a><a class="navbar__item navbar__link" sidebarid=communitySidebar href=/share/group>开源社区</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class=navbar__link aria-haspopup=true aria-expanded=false role=button href=/articles/go-sse-implementation-guide>2.9.x(Latest)</a><ul class=dropdown__menu><li><a aria-current=page class="dropdown__link dropdown__link--active" href=/articles/go-sse-implementation-guide>2.9.x(Latest)</a><li><a class=dropdown__link href=/2.8.x/docs/cli>2.8.x</a><li><a class=dropdown__link href=/2.7.x/docs/design>2.7.x</a><li><a class=dropdown__link href=/2.6.x/项目开发>2.6.x</a><li><a class=dropdown__link href=/2.5.x/项目开发>2.5.x</a><li><a class=dropdown__link href=/2.4.x/开发工具>2.4.x</a><li><a class=dropdown__link href=/2.3.x/开发工具>2.3.x</a><li><a class=dropdown__link href=/2.2.x/开发工具>2.2.x</a><li><a class=dropdown__link href=/2.1.x/开发工具>2.1.x</a><li><a class=dropdown__link href=/2.0.x/开发工具>2.0.x</a><li><a class=dropdown__link href=/1.16.x/开发工具>1.16.x</a></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>简体中文</a><ul class=dropdown__menu><li><a href=/articles/go-sse-implementation-guide rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=zh-Hans>简体中文</a><li><a href=/en/articles/go-sse-implementation-guide rel="noopener noreferrer" class=dropdown__link lang=en-US>English</a></ul></div><a href=https://github.com/gogf/gf target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>搜索</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label=回到顶部 class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label=文档侧边栏 class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/share>社区交流</a><button aria-label="展开侧边栏分类 '社区交流'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/articles>社区投稿</a><button aria-label="折叠侧边栏分类 '社区投稿'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/articles/framework-comparison-goframe-beego-iris-gin>Golang框架选型比较: goframe, beego, iris和gin</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/articles/database-transaction-practice>Go事务处理最佳实践：保证数据一致性的正确方法</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/articles/use-error-code-gracefully-in-golang>Go开发中如何优雅地使用错误码</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/articles/techempower-web-benchmarks-r23>TechEmpower Web Benchmarks最新性能评测</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/articles/rbac-permission-authentication-in-go>为Go应用增加完整的权限认证能力</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/articles/go-sse-implementation-guide>打造高性能实时通信：Go语言SSE实现指南</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/articles/go-ecommerce-database-sharding-millions>突破性能瓶颈：Go语言实现电商系统千万级数据分库分表实战</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/supportus>支持我们</a><button aria-label="展开侧边栏分类 '支持我们'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=页面路径><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label=主页面 class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/articles><span itemprop=name>社区投稿</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>打造高性能实时通信：Go语言SSE实现指南</span><meta itemprop=position content=2></ul></nav><span class="theme-doc-version-badge badge badge--secondary">版本：2.9.x(Latest)</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><p><img decoding=async loading=lazy src="data:image/webp;base64,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" width=853 height=274 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=1-什么是sse>1. 什么是SSE？<a href=#1-什么是sse class=hash-link aria-label="1. 什么是SSE？的直接链接" title="1. 什么是SSE？的直接链接">​</a></h2>
<p><code>SSE（Server-Sent Events）</code>是一种服务器推送技术，允许服务器通过<code>HTTP</code>连接向客户端发送实时更新。与<code>WebSocket</code>不同，<code>SSE</code>是单向通信机制，只能从服务器向客户端推送数据，不支持客户端向服务器发送数据。</p>
<p><code>SSE</code>的主要特点包括：</p>
<ol>
<li><strong>基于<code>HTTP</code>协议</strong>：不需要特殊的协议支持，使用标准的<code>HTTP</code>连接</li>
<li><strong>自动重连</strong>：浏览器内置支持断线重连机制</li>
<li><strong>事件Id和类型</strong>：支持消息Id和事件类型，便于客户端处理不同类型的事件</li>
<li><strong>纯文本传输</strong>：使用<code>UTF-8</code>编码的文本数据</li>
<li><strong>单向通信</strong>：只能服务器向客户端推送数据</li>
</ol>
<p><code>SSE</code>的数据格式非常简单，每条消息由一个或多个字段组成，每个字段由字段名、冒号和字段值组成，以换行符分隔：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token literal-property property" style=color:#f92672>field</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> value\n</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>一个完整的<code>SSE</code>消息示例：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token literal-property property" style=color:#f92672>id</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token plain">\n</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token literal-property property" style=color:#f92672>event</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> update\n</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token literal-property property" style=color:#f92672>data</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token string-property property" style=color:#f92672>"message"</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Hello, World!"</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain">\n\n</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>其中，双换行符（<code>\n\n</code>）表示一条消息的结束。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=2-sse的应用场景>2. SSE的应用场景<a href=#2-sse的应用场景 class=hash-link aria-label="2. SSE的应用场景的直接链接" title="2. SSE的应用场景的直接链接">​</a></h2>
<p><code>SSE</code>特别适合以下业务场景：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=21-实时数据更新>2.1 实时数据更新<a href=#21-实时数据更新 class=hash-link aria-label="2.1 实时数据更新的直接链接" title="2.1 实时数据更新的直接链接">​</a></h3>
<ul>
<li><strong>股票市场行情</strong>：将最新的股票价格、交易量等信息实时推送给用户</li>
<li><strong>体育比分直播</strong>：实时更新比赛得分、比赛状态等信息</li>
<li><strong>社交媒体信息流</strong>：推送最新的动态、评论、点赞等通知</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=22-系统监控与告警>2.2 系统监控与告警<a href=#22-系统监控与告警 class=hash-link aria-label="2.2 系统监控与告警的直接链接" title="2.2 系统监控与告警的直接链接">​</a></h3>
<ul>
<li><strong>服务器监控</strong>：实时推送CPU使用率、内存占用、网络流量等监控指标</li>
<li><strong>应用性能监控</strong>：推送应用的响应时间、错误率等性能指标</li>
<li><strong>告警通知</strong>：当系统出现异常时，立即推送告警信息</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=23-协作工具>2.3 协作工具<a href=#23-协作工具 class=hash-link aria-label="2.3 协作工具的直接链接" title="2.3 协作工具的直接链接">​</a></h3>
<ul>
<li><strong>文档协作</strong>：实时显示其他用户的编辑操作</li>
<li><strong>项目管理工具</strong>：推送任务状态变更、新评论等更新</li>
<li><strong>聊天应用</strong>：推送新消息通知</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=24-进度反馈>2.4 进度反馈<a href=#24-进度反馈 class=hash-link aria-label="2.4 进度反馈的直接链接" title="2.4 进度反馈的直接链接">​</a></h3>
<ul>
<li><strong>文件上传/下载</strong>：实时显示上传/下载进度</li>
<li><strong>长时间运行的任务</strong>：推送任务执行进度、阶段完成情况</li>
<li><strong>数据处理流程</strong>：显示数据处理的各个阶段和进度</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=3-sse在ai领域的应用>3. SSE在AI领域的应用<a href=#3-sse在ai领域的应用 class=hash-link aria-label="3. SSE在AI领域的应用的直接链接" title="3. SSE在AI领域的应用的直接链接">​</a></h2>
<p><code>SSE</code>在<code>AI</code>领域有着广泛的应用，特别是在需要流式输出<code>AI</code>生成内容的场景中：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=31-大型语言模型的流式响应>3.1 大型语言模型的流式响应<a href=#31-大型语言模型的流式响应 class=hash-link aria-label="3.1 大型语言模型的流式响应的直接链接" title="3.1 大型语言模型的流式响应的直接链接">​</a></h3>
<p>当用户向<code>ChatGPT</code>、<code>DeepSeek</code>等大型语言模型提问时，模型通常需要一定时间才能生成完整回答。使用<code>SSE</code>可以实现：</p>
<ul>
<li><strong>逐字输出</strong>：模型生成一个词就立即返回给用户，而不是等待整个回答生成完毕</li>
<li><strong>思考过程可视化</strong>：让用户看到<code>AI</code>的“思考”过程，提升交互体验</li>
<li><strong>提前终止</strong>：用户可以在看到部分回答后决定是否需要终止生成过程</li>
</ul>
<p>这种方式大大提升了用户体验，减少了等待时间，同时给人一种<code>AI</code>正在实时思考和回应的感觉。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=32-ai图像生成过程>3.2 AI图像生成过程<a href=#32-ai图像生成过程 class=hash-link aria-label="3.2 AI图像生成过程的直接链接" title="3.2 AI图像生成过程的直接链接">​</a></h3>
<p>在<code>AI</code>图像生成场景中，<code>SSE</code>可用于：</p>
<ul>
<li><strong>渐进式渲染</strong>：展示图像从模糊到清晰的生成过程</li>
<li><strong>中间结果展示</strong>：显示不同迭代步骤的图像结果</li>
<li><strong>生成参数反馈</strong>：实时反馈模型使用的参数和处理状态</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=33-语音识别和实时翻译>3.3 语音识别和实时翻译<a href=#33-语音识别和实时翻译 class=hash-link aria-label="3.3 语音识别和实时翻译的直接链接" title="3.3 语音识别和实时翻译的直接链接">​</a></h3>
<p>在语音识别和实时翻译场景中：</p>
<ul>
<li><strong>流式语音转文字</strong>：用户说话的同时，文字实时显示出来</li>
<li><strong>实时翻译</strong>：源语言被识别的同时，目标语言的翻译结果实时生成</li>
<li><strong>置信度反馈</strong>：显示识别或翻译结果的置信度，并在有更好结果时更新</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=34-ai辅助编程>3.4 AI辅助编程<a href=#34-ai�辅助编程 class=hash-link aria-label="3.4 AI辅助编程的直接链接" title="3.4 AI辅助编程的直接链接">​</a></h3>
<p>在像<code>GitHub Copilot</code>这样的AI编程助手中：</p>
<ul>
<li><strong>代码补全建议</strong>：实时提供代码补全建议，而不是等待完整的代码块生成</li>
<li><strong>多方案展示</strong>：同时流式展示多个可能的代码实现方案</li>
<li><strong>解释和文档</strong>：实时生成代码解释和文档</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=4-使用go实现sse>4. 使用Go实现SSE<a href=#4-使用go实现sse class=hash-link aria-label="4. 使用Go实现SSE的直接链接" title="4. 使用Go实现SSE的直接链接">​</a></h2>
<p><img decoding=async loading=lazy src=/assets/images/go-sse-9d1f1b207907e7d97eb047505f2f6394.webp width=918 height=575 class=img_ev3q></p>
<p>使用<code>Go</code>来实现一个<code>SSE</code>服务非常简单。下面我们将详细介绍如何使用<code>GoFrame</code>框架来实现<code>SSE</code>服务。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=41-基础sse实现>4.1 基础SSE实现<a href=#41-基础sse实现 class=hash-link aria-label="4.1 基础SSE实现的直接链接" title="4.1 基础SSE实现的直接链接">​</a></h3>
<p>首先，我们需要创建一个基本的<code>SSE</code>处理器，设置正确的<code>HTTP</code>头信息，并保持连接打开：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// SseHandler 基础SSE处理器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>SseHandler</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">r </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">ghttp</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Request</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 设置SSE必要的HTTP头</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Header</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Set</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Content-Type"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"text/event-stream"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Header</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Set</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Cache-Control"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"no-cache"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Header</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Set</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Connection"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"keep-alive"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Header</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Set</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Access-Control-Allow-Origin"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"*"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 模拟发送一些消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> i </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> i </span><span class="token operator" style=color:#66d9ef>&lt;=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>5</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> i</span><span class="token operator" style=color:#66d9ef>++</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 发送消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"data: %d"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> i</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id: %d"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> i</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"event: message\n"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"data: {\"message\": \"Hello SSE %d\"}\n"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> i</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 立即刷新到客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Flush</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 模拟处理时间</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sleep</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>1</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Second</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<blockquote>
<p>其中<code>r.Response.Writefln</code>方法用于格式化写入数据到<code>HTTP</code>响应中，并在写入内容末尾增加换行符号输出。</p>
</blockquote>
<p>然后在路由中注册这个处理器：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Server</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"/"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">group </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">ghttp</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">RouterGroup</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    group</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>GET</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"/sse"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> SseHandler</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>客户端可以使用浏览器原生<code>EventSource API</code>来连接这个端点：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 客户端代码</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>const</span><span class="token plain"> eventSource </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>new</span><span class="token plain"> </span><span class="token class-name" style=color:#e6db74>EventSource</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'/sse'</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 监听消息事件</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">eventSource</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>addEventListener</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'message'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>function</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token parameter">e</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  </span><span class="token keyword" style=color:#66d9ef>const</span><span class="token plain"> data </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token constant" style=color:#e6db74>JSON</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>parse</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">e</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  console</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>log</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'Received message:'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">message</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 监听连接打开事件</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">eventSource</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function-variable function" style=color:#e6db74>onopen</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>function</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  console</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>log</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'Connection to server opened.'</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 监听错误</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">eventSource</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function-variable function" style=color:#e6db74>onerror</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>function</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token parameter">e</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">  console</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'EventSource failed:'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> e</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 关闭连接</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">eventSource</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>close</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=42-实现更灵活的sse服务>4.2 实现更灵活的SSE服务<a href=#42-实现更灵活的sse服务 class=hash-link aria-label="4.2 实现更灵活的SSE服务的直接链接" title="4.2 实现更灵活的SSE服务的直接链接">​</a></h3>
<p>为了更好地管理<code>SSE</code>连接和消息发送，我们可以实现一个更完整的<code>SSE</code>服务。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=421-常见的sse业务场景>4.2.1 常见的SSE业务场景<a href=#421-常见的sse业务场景 class=hash-link aria-label="4.2.1 常见的SSE业务场景的直接链接" title="4.2.1 常见的SSE业务场景的直接链接">​</a></h4>
<p>在实际应用中，除了客户端单次请求产生的流式输出（例如一次简短的<code>AI Chat</code>回答），我们通常还需要实现两种消息发送模式：</p>
<ul>
<li>向指定客户端发送消息（<code>SendToClient</code>）</li>
<li>向所有客户端广播消息（<code>BroadcastMessage</code>）</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=4211-向指定客户端发送消息的场景>4.2.1.1 向指定客户端发送消息的场景<a href=#4211-向指定客户端发送消息的场景 class=hash-link aria-label="4.2.1.1 向指定客户端发送消息的场景的直接链接" title="4.2.1.1 向指定客户端发送消息的场景的直接链接">​</a></h5>
<ol>
<li>
<p><strong>个性化通知</strong></p>
<ul>
<li>用户特定的提醒（如账单到期、预约提醒）</li>
<li>针对特定用户的系统消息（如账户状态变更）</li>
</ul>
</li>
<li>
<p><strong>AI应用中的流式响应</strong></p>
<ul>
<li>AI聊天应用需要将生成的内容实时流式发送给发起请求的特定用户</li>
<li>文档生成、代码补全等需要长时间处理的任务的进度和结果</li>
</ul>
</li>
<li>
<p><strong>异步任务完成通知</strong></p>
<ul>
<li>后台处理长时间运行的任务（如文件处理、数据导入），完成后通知发起任务的用户</li>
<li>订单状态变更通知给下单用户</li>
</ul>
</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=4212-广播消息的场景>4.2.1.2 广播消息的场景<a href=#4212-广播消息的场景 class=hash-link aria-label="4.2.1.2 广播消息的场景的直接链接" title="4.2.1.2 广播消息的场景的直接链接">​</a></h5>
<ol>
<li>
<p><strong>系统公告</strong></p>
<ul>
<li>系统维护通知</li>
<li>全局功能更新公告</li>
<li>紧急事件通知</li>
</ul>
</li>
<li>
<p><strong>实时数据更新</strong></p>
<ul>
<li>股票、加密货币价格变动</li>
<li>体育比赛比分更新</li>
<li>天气预警信息</li>
</ul>
</li>
<li>
<p><strong>多用户协作环境</strong></p>
<ul>
<li>共享看板或仪表盘的数据更新</li>
<li>团队聊天中的新消息通知</li>
</ul>
</li>
</ol>
<p>这些场景都可以通过我们即将实现的<code>SendToClient</code>和<code>BroadcastMessage</code>方法来支持。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=422-实现sse服务>4.2.2 实现<code>SSE</code>服务<a href=#422-实现sse服务 class=hash-link aria-label=422-实现sse服务的直接链接 title=422-实现sse服务的直接链接>​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// internal/logic/sse/sse.go</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Client 表示SSE客户端连接</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> Client </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Id          </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Request     </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">ghttp</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Request</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    messageChan </span><span class="token keyword" style=color:#66d9ef>chan</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Service SSE服务</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> Service </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    clients </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gmap</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">StrAnyMap  </span><span class="token comment" style=color:#8292a2;font-style:italic>// 存储所有客户端连接</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// New 创建SSE服务实例</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        clients</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> gmap</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>NewStrAnyMap</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token boolean" style=color:#ae81ff>true</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Create 创建SSE连接</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>Create</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">r </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">ghttp</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Request</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 设置SSE必要的HTTP头</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Header</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Set</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Content-Type"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"text/event-stream"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Header</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Set</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Cache-Control"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"no-cache"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Header</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Set</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Connection"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"keep-alive"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Header</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Set</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"Access-Control-Allow-Origin"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"*"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 创建新客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    clientId </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Get</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"client_id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> guid</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>S</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>String</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    client </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">Client</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Id</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">      clientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Request</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> r</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        messageChan</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>make</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token keyword" style=color:#66d9ef>chan</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 注册客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">clients</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Set</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> client</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 客户端断开连接时清理</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">clients</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Remove</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token function" style=color:#e6db74>close</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">client</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">messageChan</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 发送连接成功消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id: %s"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> clientId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"event: connected"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"data: {\"status\": \"connected\", \"client_id\": \"%s\"}\n"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> clientId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Flush</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 处理消息发送</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>select</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>case</span><span class="token plain"> msg</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ok </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&lt;-</span><span class="token plain">client</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">messageChan</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>!</span><span class="token plain">ok </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 向客户端发送消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">msg</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Flush</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>case</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&lt;-</span><span class="token plain">r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Context</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Done</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 客户端断开连接</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// SendToClient 向指定客户端发送消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>SendToClient</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data </span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>bool</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> client </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">clients</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Get</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> client </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        c </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> client</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Client</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        msg </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> fmt</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sprintf</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token string" style=color:#a6e22e>"id: %d\nevent: %s\ndata: %s\n\n"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Now</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>UnixNano</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 尝试发送消息，如果缓冲区满则跳过</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>select</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>case</span><span class="token plain"> c</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">messageChan </span><span class="token operator" style=color:#66d9ef>&lt;-</span><span class="token plain"> msg</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>default</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>false</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>false</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// BroadcastMessage 向所有客户端广播消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>BroadcastMessage</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data </span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>int</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    count </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">clients</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Iterator</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">k </span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> v </span><span class="token keyword" style=color:#66d9ef>interface</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>bool</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SendToClient</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">k</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            count</span><span class="token operator" style=color:#66d9ef>++</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> count</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// heartbeatSender 定时发送心跳包</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>heartbeatSender</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ticker </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>NewTicker</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>30</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Second</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> ticker</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Stop</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>range</span><span class="token plain"> ticker</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">C </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">clients</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Iterator</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">k </span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> v </span><span class="token keyword" style=color:#66d9ef>interface</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>bool</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            client </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> v</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Client</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>select</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>case</span><span class="token plain"> client</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">messageChan </span><span class="token operator" style=color:#66d9ef>&lt;-</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>": heartbeat\n\n"</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic>// 心跳包发送成功</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>default</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic>// 消息缓冲区满，可能客户端已断开</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=423-在控制器中使用这个服务>4.2.3 在控制器中使用这个服务<a href=#423-在控制器中使用这个服务 class=hash-link aria-label="4.2.3 在控制器中使用这个服务的直接链接" title="4.2.3 在控制器中使用这个服务的直接链接">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=4231-创建控制器>4.2.3.1 创建控制器<a href=#4231-创建控制器 class=hash-link aria-label="4.2.3.1 创建控制器的直接链接" title="4.2.3.1 创建控制器的直接链接">​</a></h5>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// internal/controller/sse/sse.go</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> Controller </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    service </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">sse</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Service</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Controller </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">Controller</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        service</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> sse</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=4232-创建sse接口>4.2.3.2 创建SSE接口<a href=#4232-创建sse接口 class=hash-link aria-label="4.2.3.2 创建SSE接口的直接链接" title="4.2.3.2 创建SSE接口的直接链接">​</a></h5>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> SseReq </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Meta </span><span class="token string" style=color:#a6e22e>`path:"/sse/create" method:"post"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> SseRes </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Sse SSE连接</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">c </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Controller</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>Sse</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">SseReq</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">res </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">SseRes</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    c</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">service</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Create</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>RequestFromCtx</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">SseRes</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=4233-发送消息的接口>4.2.3.3 发送消息的接口<a href=#4233-发送消息的接口 class=hash-link aria-label="4.2.3.3 发送消息的接口的直接链接" title="4.2.3.3 发送消息的接口的直接链接">​</a></h5>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> SendMessageReq </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Meta </span><span class="token string" style=color:#a6e22e>`path:"/sse/send" method:"post"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ClientId  </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    EventType </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Data      </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> SendMessageRes </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// SendMessage 发送消息给指定客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">c </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Controller</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>SendMessage</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">SendMessageReq</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">res </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">SendMessageRes</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    success </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> c</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">service</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SendToClient</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ClientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">EventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">SendMessageRes</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id=4234-广播消息的接口>4.2.3.4 广播消息的接口<a href=#4234-广播消息的接口 class=hash-link aria-label="4.2.3.4 广播消息的接口的直接链接" title="4.2.3.4 广播消息的接口的直接链接">​</a></h5>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> BroadcastMessageReq </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Meta </span><span class="token string" style=color:#a6e22e>`path:"/sse/broadcast" method:"post"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    EventType </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Data      </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> BroadcastMessageRes </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// BroadcastMessage 广播消息给所有客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">c </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Controller</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>BroadcastMessage</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">BroadcastMessageReq</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">res </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">BroadcastMessageRes</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    count </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> c</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">service</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>BroadcastMessage</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">EventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">BroadcastMessageRes</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=424-注册路由>4.2.4 注册路由<a href=#424-注册路由 class=hash-link aria-label="4.2.4 注册路由的直接链接" title="4.2.4 注册路由的直接链接">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Server</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"/api"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">group </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">ghttp</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">RouterGroup</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    group</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Bind</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"/"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> sse</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=43-client_id的设计与客户端交互>4.3 client_id的设计与客户端交互<a href=#43-client_id的设计与客户端交互 class=hash-link aria-label="4.3 client_id的设计与客户端交互的直接链接" title="4.3 client_id的设计与客户端交互的直接链接">​</a></h3>
<p>在实现<code>SSE</code>服务时，一个关键的设计是<code>client_id</code>的管理。<code>client_id</code>用于唯一标识每个<code>SSE</code>连接，使服务器可以将消息准确地发送给特定的客户端。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=431-client_id的生成与获取>4.3.1 client_id的生成与获取<a href=#431-client_id的生成与获取 class=hash-link aria-label="4.3.1 client_id的生成与获取的直接链接" title="4.3.1 client_id的生成与获取的直接链接">​</a></h4>
<p>在<code>GoFrame</code>中，我们使用以下方式生成和获取<code>client_id</code>：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 获取或生成客户端Id</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">clientId </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Get</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"client_id"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> guid</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>S</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>String</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这行代码的工作原理是：</p>
<ol>
<li>首先尝试从请求参数中获取<code>client_id</code>，这允许客户端在请求中传递自己的Id</li>
<li>如果请求中没有提供<code>client_id</code>，则使用<code>guid.S()</code>生成一个新的Id</li>
</ol>
<p><code>guid.S</code>会返回一个字符串形式的全局唯一字符串Id，这确保了即使客户端没有提供自己的Id，我们仍然可以为每个连接分配一个唯一的标识符。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=432-client_id的客户端交互流程>4.3.2 client_id的客户端交互流程<a href=#432-client_id的客户端交互流程 class=hash-link aria-label="4.3.2 client_id的客户端交互流程的直接链接" title="4.3.2 client_id的客户端交互流程的直接链接">​</a></h4>
<p>客户端与服务器交互的完整流程如下：</p>
<ol>
<li>
<p><strong>客户端首次连接</strong>：客户端通过<code>EventSource API</code>连接到<code>SSE</code>端点，此时没有提供<code>client_id</code></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>const</span><span class="token plain"> eventSource </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>new</span><span class="token plain"> </span><span class="token class-name" style=color:#e6db74>EventSource</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'/api/sse'</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p><strong>服务器生成<code>client_id</code></strong>：服务器使用<code>guid.S()</code>生成一个新的<code>client_id</code></p>
</li>
<li>
<p><strong>将<code>client_id</code>发送给客户端</strong>：服务器在连接建立后发送一个特殊的事件，包含<code>client_id</code></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 发送连接成功消息，包含client_id</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"id: %s"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> clientId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"event: connected"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Writefln</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"data: {\"status\": \"connected\", \"client_id\": \"%s\"}\n"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> clientId</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p><strong>客户端保存<code>client_id</code></strong>：客户端接收到<code>connected</code>事件，并保存<code>client_id</code></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">eventSource</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>addEventListener</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'connected'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>function</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token parameter">e</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>const</span><span class="token plain"> data </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token constant" style=color:#e6db74>JSON</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>parse</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">e</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    clientId </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> data</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">client_id</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    console</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>log</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'Connected to SSE, client Id:'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> clientId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p><strong>后续请求中使用<code>client_id</code></strong>：客户端在后续的API请求中包含<code>client_id</code></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 发送请求到服务器，带上client_id</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>const</span><span class="token plain"> response </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>await</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>fetch</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'/api/ai/chat'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token literal-property property" style=color:#f92672>method</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'POST'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token literal-property property" style=color:#f92672>headers</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token string-property property" style=color:#f92672>'Content-Type'</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>'application/json'</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token literal-property property" style=color:#f92672>body</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> </span><span class="token constant" style=color:#e6db74>JSON</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>stringify</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token literal-property property" style=color:#f92672>prompt</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> prompt</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token literal-property property" style=color:#f92672>client_id</span><span class="token operator" style=color:#66d9ef>:</span><span class="token plain"> clientId  </span><span class="token comment" style=color:#8292a2;font-style:italic>// 将保存的client_id发送给服务器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p><strong>服务器使用<code>client_id</code>发送定向消息</strong>：服务器处理请求并使用<code>client_id</code>将响应发送到正确的<code>SSE</code>连接</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 发送到客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">c</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">service</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SendToClient</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"ai_response"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=433-client_id的存储与管理>4.3.3 client_id的存储与管理<a href=#433-client_id的存储与管理 class=hash-link aria-label="4.3.3 client_id的存储与管理的直接链接" title="4.3.3 client_id的存储与管理的直接链接">​</a></h4>
<p>在服务器端，我们使用一个并发安全的内存映射表来管理所有的客户端连接：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// SseService SSE服务</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> SseService </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    clients </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">gmap</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">StrAnyMap  </span><span class="token comment" style=color:#8292a2;font-style:italic>// 存储所有客户端连接</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>当客户端连接时，我们将其添加到映射表中：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 注册客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">clients</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Set</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> client</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>当客户端断开连接时，我们将其从映射表中移除：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 客户端断开连接时清理</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">clients</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Remove</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientId</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token function" style=color:#e6db74>close</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">client</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">messageChan</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=44-在ai应用中使用sse的实现>4.4 在AI应用中使用SSE的实现<a href=#44-在ai应用中使用sse的实现 class=hash-link aria-label="4.4 在AI应用中使用SSE的实现的直接链接" title="4.4 在AI应用中使用SSE的实现的直接链接">​</a></h3>
<p>下面我们将实现一个简单的AI流式输出应用，模拟大语言模型的逐字响应：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// controller/ai/chat.go</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 模拟AI响应的预设回答</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>var</span><span class="token plain"> aiResponses </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>`</span><br></span><span class=token-line style=color:#f8f8f2><span class="token string" style=color:#a6e22e>GoFrame是一款模块化、高性能、企业级的Go基础开发框架。</span><br></span><span class=token-line style=color:#f8f8f2><span class="token string" style=color:#a6e22e>SSE（Server-Sent Events）是一种允许服务器向客户端推送数据的技术。</span><br></span><span class=token-line style=color:#f8f8f2><span class="token string" style=color:#a6e22e>与WebSocket不同，SSE是单向通信，只能服务器向客户端发送数据。</span><br></span><span class=token-line style=color:#f8f8f2><span class="token string" style=color:#a6e22e>使用SSE可以实现AI模型的流式输出，提升用户体验。</span><br></span><span class=token-line style=color:#f8f8f2><span class="token string" style=color:#a6e22e>`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// StreamChatRequest 流式聊天请求</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> StreamChatRequest </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Meta </span><span class="token string" style=color:#a6e22e>`path:"/ai/stream-chat" method:"post"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Prompt   </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>`v:"required#请输入问题"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ClientId </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>`v:"required#请输入client_id"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// StreamChatResponse 流式聊天响应</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> StreamChatResponse </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Content </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>`json:"content"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Done    </span><span class="token builtin" style=color:#e6db74>bool</span><span class="token plain">   </span><span class="token string" style=color:#a6e22e>`json:"done"`</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// StreamChat 流式聊天API</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">c </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Controller</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>StreamChat</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> req </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">StreamChatRequest</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">res </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">StreamChatResponse</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token builtin" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 获取或生成客户端Id</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ClientId </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ClientId </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> guid</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>S</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 启动一个goroutine来模拟AI处理和流式响应</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>go</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 将回答拆分为单个字符</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        words </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> gstr</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SplitAndTrim</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">aiResponses</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>" "</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 模拟思考时间</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sleep</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>500</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Millisecond</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 逐字发送回答</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> i</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> char </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>range</span><span class="token plain"> words </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 构建响应</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            resp </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> StreamChatResponse</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                Content</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> char</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                Done</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">    i </span><span class="token operator" style=color:#66d9ef>==</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>len</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">words</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token operator" style=color:#66d9ef>-</span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 转为JSON</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            data</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> json</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Marshal</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">resp</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 发送到客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            c</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">service</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SendToClient</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">req</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ClientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"ai_response"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 模拟打字延迟</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sleep</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>100</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Millisecond</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 返回成功，实际内容会通过SSE发送</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">StreamChatResponse</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Content</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"请求已接收，响应将通过SSE流式返回"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Done</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">    </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>在路由中注册这个API：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Server</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Group</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"/api"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">group </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">ghttp</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">RouterGroup</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// SSE API</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    group</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Bind</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"/"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> sse</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// AI聊天API</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    group</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Bind</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>"/"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> ai</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>New</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=45-使用redis实现分布式sse服务>4.5 使用Redis实现分布式SSE服务<a href=#45-使用redis实现分布式sse服务 class=hash-link aria-label="4.5 使用Redis实现分布式SSE服务的直接链接" title="4.5 使用Redis实现分布式SSE服务的直接链接">​</a></h3>
<p>在生产环境中，我们通常需要部署多个服务实例来处理大量的请求。
为了确保<code>SSE</code>消息能够在不同实例之间正确传递，我们可以使用<code>Redis</code>的<strong>发布/订阅</strong>功能来实现分布式<code>SSE</code>服务。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=451-client_id在分布式系统中的应用>4.5.1 client_id在分布式系统中的应用<a href=#451-client_id在分布式系统中的应用 class=hash-link aria-label="4.5.1 client_id在分布式系统中的应用的直接链接" title="4.5.1 client_id在分布式系统中的应用的直接链接">​</a></h4>
<p>在分布式系统中，客户端可能连接到不同的服务实例(<code>HTTP Server</code>)。这时，<code>client_id</code>的作用就更加重要：</p>
<ol>
<li>客户端保存<code>client_id</code>并在所有请求中使用它</li>
<li>服务器使用<code>Redis</code>等分布式消息系统将消息路由到正确的服务实例</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 发布消息到Redis，包含client_id信息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">msg </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> RedisMessage</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ClientId</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">  clientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain">  </span><span class="token comment" style=color:#8292a2;font-style:italic>// 指定目标客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    EventType</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Data</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">      data</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Broadcast</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> broadcast</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>这种设计确保了即使在多服务实例的环境中，消息也能准确地发送给指定的客户端。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=452-redis消息的发布>4.5.2 Redis消息的发布<a href=#452-redis消息的发布 class=hash-link aria-label="4.5.2 Redis消息的发布的直接链接" title="4.5.2 Redis消息的发布的直接链接">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// internal/logic/sse/sse_redis.go</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// Redis通道名</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>const</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    RedisSseChannel </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"sse:messages"</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// PublishToRedis 发布消息到Redis</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>PublishToRedis</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data </span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> broadcast </span><span class="token builtin" style=color:#e6db74>bool</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    msg </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> RedisMessage</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        ClientId</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">  clientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        EventType</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Data</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain">      data</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        Broadcast</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"> broadcast</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 序列化消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    bytes</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> json</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Marshal</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">msg</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 发布到Redis</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token boolean" style=color:#ae81ff>_</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">redis</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Publish</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> RedisSseChannel</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">bytes</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> err</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=453-redis消息的订阅>4.5.3 Redis消息的订阅<a href=#453-redis消息的订阅 class=hash-link aria-label="4.5.3 Redis消息的订阅的直接链接" title="4.5.3 Redis消息的订阅的直接链接">​</a></h4>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// internal/logic/sse/sse_redis.go</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// StartRedisSubscriber 启动Redis订阅器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>StartRedisSubscriber</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ctx </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Background</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 创建redis订阅对象</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    pubsub </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">redis</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Subscribe</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> RedisSseChannel</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> pubsub</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Close</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 获取消息通道</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    msgChan </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> pubsub</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Channel</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>go</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 处理接收到的消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> msg </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>range</span><span class="token plain"> msgChan </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>var</span><span class="token plain"> redisMsg RedisMessage</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> json</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Unmarshal</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token function" style=color:#e6db74>byte</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">msg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Payload</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">redisMsg</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                g</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Log</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Error</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Parse redis message error:"</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> err</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token keyword" style=color:#66d9ef>continue</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 处理消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> redisMsg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Broadcast </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic>// 广播消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>BroadcastMessage</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">redisMsg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">EventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> redisMsg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> redisMsg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ClientId </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>""</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic>// 发送给指定客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SendToClient</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">redisMsg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ClientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> redisMsg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">EventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> redisMsg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// SendMessage 发送消息给指定客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>SendMessage</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data </span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>PublishToRedis</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>false</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// BroadcastMessage 广播消息给所有客户端</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>BroadcastMessage</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data </span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>PublishToRedis</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>""</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> eventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> data</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>true</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=454-初始化redis订阅器>4.5.4 初始化Redis订阅器<a href=#454-初始化redis订阅器 class=hash-link aria-label="4.5.4 初始化Redis订阅器的直接链接" title="4.5.4 初始化Redis订阅器的直接链接">​</a></h4>
<p>最后，在服务启动时初始化<code>Redis</code>订阅器：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// main.go</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>main</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 启动Redis订阅器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    sseService</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>StartRedisSubscriber</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 启动HTTP服务</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// ...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=5-sse实现的最佳实践>5. SSE实现的最佳实践<a href=#5-sse实现的最佳实践 class=hash-link aria-label="5. SSE实现的最佳实践的直接链接" title="5. SSE实现的最佳实践的直接链接">​</a></h2>
<p>在实现<code>SSE</code>服务时，有一些最佳实践需要注意：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=51-服务器配置>5.1 服务器配置<a href=#51-服务器配置 class=hash-link aria-label="5.1 服务器配置的直接链接" title="5.1 服务器配置的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=511-服务器并发连接优化>5.1.1 服务器并发连接优化<a href=#511-服务器并发连接优化 class=hash-link aria-label="5.1.1 服务器并发连接优化的直接链接" title="5.1.1 服务器并发连接优化的直接链接">​</a></h4>
<p><code>SSE</code>连接会长时间保持打开状态，需要对服务器进行适当的优化以处理大量并发连接。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic># 增加系统打开文件数限制</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token function" style=color:#e6db74>sysctl</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-w</span><span class="token plain"> fs.file-max</span><span class="token operator" style=color:#66d9ef>=</span><span class="token number" style=color:#ae81ff>100000</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic># 调整当前用户的限制</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token builtin class-name" style=color:#e6db74>ulimit</span><span class="token plain"> </span><span class="token parameter variable" style=color:#f8f8f2>-n</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>100000</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<blockquote>
<p>如果使用的是云服务器，云服务器厂商通常已经优化了系统配置，请查看确认系统配置即可。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=512-调整超时设置>5.1.2 调整超时设置<a href=#512-调整超时设置 class=hash-link aria-label="5.1.2 调整超时设置的直接链接" title="5.1.2 调整超时设置的直接链接">​</a></h4>
<p><code>SSE</code>连接需要长时间保持，应调整相关超时设置。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 调整超时设置</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SetReadTimeout</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic>// 禁用读取超时</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SetWriteTimeout</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">     </span><span class="token comment" style=color:#8292a2;font-style:italic>// 禁用写入超时</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SetIdleTimeout</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain">      </span><span class="token comment" style=color:#8292a2;font-style:italic>// 禁用空闲超时</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<blockquote>
<p>如果使用的是<code>GoFrame</code>框架实现<code>SSE</code>，默认配置下的写入时间不超时。因此开发者对<code>Server</code>不需要做额外配置。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=52-客户端重连机制>5.2 客户端重连机制<a href=#52-客户端重连机制 class=hash-link aria-label="5.2 客户端重连机制的直接链接" title="5.2 客户端重连机制的直接链接">​</a></h3>
<p>虽然浏览器的<code>EventSource API</code>内置了重连机制，但在某些情况下可能需要自定义重连逻辑：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 自定义重连逻辑</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>let</span><span class="token plain"> reconnectAttempts </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>const</span><span class="token plain"> maxReconnectAttempts </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>5</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>const</span><span class="token plain"> baseReconnectDelay </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1000</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 1秒</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>function</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>connectSSE</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    eventSource </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>new</span><span class="token plain"> </span><span class="token class-name" style=color:#e6db74>EventSource</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'/api/sse'</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 连接打开时重置重连计数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    eventSource</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function-variable function" style=color:#e6db74>onopen</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>function</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        reconnectAttempts </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        console</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>log</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'SSE connection established'</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 错误处理和重连</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    eventSource</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function-variable function" style=color:#e6db74>onerror</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>function</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token parameter">e</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        eventSource</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>close</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">reconnectAttempts </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain"> maxReconnectAttempts</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            reconnectAttempts</span><span class="token operator" style=color:#66d9ef>++</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 指数退避重连</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>const</span><span class="token plain"> delay </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> baseReconnectDelay </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> Math</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>pow</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>2</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> reconnectAttempts </span><span class="token operator" style=color:#66d9ef>-</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            console</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>log</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token template-string template-punctuation string" style=color:#a6e22e>`</span><span class="token template-string string" style=color:#a6e22e>Reconnecting in </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#f8f8f2>${</span><span class="token template-string interpolation">delay</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#f8f8f2>}</span><span class="token template-string string" style=color:#a6e22e>ms (attempt </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#f8f8f2>${</span><span class="token template-string interpolation">reconnectAttempts</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#f8f8f2>}</span><span class="token template-string string" style=color:#a6e22e>/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#f8f8f2>${</span><span class="token template-string interpolation">maxReconnectAttempts</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#f8f8f2>}</span><span class="token template-string string" style=color:#a6e22e>)</span><span class="token template-string template-punctuation string" style=color:#a6e22e>`</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token function" style=color:#e6db74>setTimeout</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">connectSSE</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> delay</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            console</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>error</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token string" style=color:#a6e22e>'Max reconnect attempts reached'</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=53-资源管理>5.3 资源管理<a href=#53-资源管理 class=hash-link aria-label="5.3 资源管理的直接链接" title="5.3 资源管理的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=531-关闭未使用的连接>5.3.1 关闭未使用的连接<a href=#531-关闭未使用的连接 class=hash-link aria-label="5.3.1 关闭未使用的连接的直接链接" title="5.3.1 关闭未使用的连接的直接链接">​</a></h4>
<p>服务端定期检查并关闭长时间空闲的连接，避免资源浪费。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 添加最后活动时间字段</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> Client </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    Id            </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    messageChan   </span><span class="token keyword" style=color:#66d9ef>chan</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>string</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    lastActiveTime time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Time</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 定期清理空闲连接</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>startIdleConnectionCleaner</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ticker </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>NewTicker</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>5</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain"> time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Minute</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> ticker</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Stop</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>range</span><span class="token plain"> ticker</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">C </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        now </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Now</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token comment" style=color:#8292a2;font-style:italic>// 使用LockFunc安全地执行删除操作</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">clients</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>LockFunc</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">m </span><span class="token keyword" style=color:#66d9ef>map</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token builtin" style=color:#e6db74>string</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token keyword" style=color:#66d9ef>interface</span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> k</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> v </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>range</span><span class="token plain"> m </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                client </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> v</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Client</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic>// 如果超过30分钟没有活动，关闭连接</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> now</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Sub</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">client</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">lastActiveTime</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>></span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>30</span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">time</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Minute </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token function" style=color:#e6db74>close</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">client</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">messageChan</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    </span><span class="token function" style=color:#e6db74>delete</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">m</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> k</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=532-限制连接数>5.3.2 限制连接数<a href=#532-限制连接数 class=hash-link aria-label="5.3.2 限制连接数的直接链接" title="5.3.2 限制连接数的直接链接">​</a></h4>
<p>为了防止资源耗尽，可以限制每个Ip的最大连接数。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 添加Ip连接计数器</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>var</span><span class="token plain"> ipConnections </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> gmap</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>NewStrIntMap</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token boolean" style=color:#ae81ff>true</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>Create</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">r </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">ghttp</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Request</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 获取客户端Ip</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    clientIp </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>GetClientIp</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 在创建SSE新连接前检查连接数限制</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> count </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> ipConnections</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>GetOrSet</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientIp</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> count </span><span class="token operator" style=color:#66d9ef>>=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>5</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        r</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Response</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>WriteStatus</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token number" style=color:#ae81ff>429</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token string" style=color:#a6e22e>"Too many connections"</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 增加连接计数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ipConnections</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Add</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientIp</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 连接关闭时减少计数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> ipConnections</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Add</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">clientIp</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>-</span><span class="token number" style=color:#ae81ff>1</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 继续处理SSE连接...</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=54-消息队列优化>5.4 消息队列优化<a href=#54-消息队列优化 class=hash-link aria-label="5.4 消息队列优化的直接链接" title="5.4 消息队列优化的直接链接">​</a></h3>
<p>对于高并发场景，可以使用更高效的消息队列消费设计，通过多个<code>goroutine</code>来并行处理消息，降低消息处理延迟：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token comment" style=color:#8292a2;font-style:italic>// 使用带缓冲的通道作为消息队列</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>var</span><span class="token plain"> messageQueue </span><span class="token operator" style=color:#66d9ef>=</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>make</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token keyword" style=color:#66d9ef>chan</span><span class="token plain"> RedisMessage</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>1000</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// 启动Redis订阅器并分发消息到工作协程</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token keyword" style=color:#66d9ef>func</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">s </span><span class="token operator" style=color:#66d9ef>*</span><span class="token plain">Service</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token function" style=color:#e6db74>StartRedisSubscriber</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx context</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Context</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> workerCount </span><span class="token builtin" style=color:#e6db74>int</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token builtin" style=color:#e6db74>error</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 创建redis订阅对象</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    pubsub </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">redis</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Subscribe</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">ctx</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> RedisSseChannel</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 获取消息通道</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    msgChan </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> pubsub</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Channel</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 启动消息分发协程</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>go</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>defer</span><span class="token plain"> pubsub</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Close</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> msg </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>range</span><span class="token plain"> msgChan </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 解析消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>var</span><span class="token plain"> redisMsg RedisMessage</span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> json</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>Unmarshal</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>[</span><span class="token punctuation" style=color:#f8f8f2>]</span><span class="token function" style=color:#e6db74>byte</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">msg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Payload</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> </span><span class="token operator" style=color:#66d9ef>&</span><span class="token plain">redisMsg</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> err </span><span class="token operator" style=color:#66d9ef>!=</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token keyword" style=color:#66d9ef>continue</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token comment" style=color:#8292a2;font-style:italic>// 将消息发送到工作队列</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>select</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>case</span><span class="token plain"> messageQueue </span><span class="token operator" style=color:#66d9ef>&lt;-</span><span class="token plain"> redisMsg</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic>// 消息成功发送到队列</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>default</span><span class="token punctuation" style=color:#f8f8f2>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic>// 队列已满，丢弃消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token comment" style=color:#8292a2;font-style:italic>// 启动工作协程池</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> i </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token number" style=color:#ae81ff>0</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> i </span><span class="token operator" style=color:#66d9ef>&lt;</span><span class="token plain"> workerCount</span><span class="token punctuation" style=color:#f8f8f2>;</span><span class="token plain"> i</span><span class="token operator" style=color:#66d9ef>++</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token keyword" style=color:#66d9ef>go</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>func</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token keyword" style=color:#66d9ef>for</span><span class="token plain"> msg </span><span class="token operator" style=color:#66d9ef>:=</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>range</span><span class="token plain"> messageQueue </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token comment" style=color:#8292a2;font-style:italic>// 处理消息</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token keyword" style=color:#66d9ef>if</span><span class="token plain"> msg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Broadcast </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>BroadcastMessage</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">msg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">EventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> msg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"> </span><span class="token keyword" style=color:#66d9ef>else</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                    s</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token function" style=color:#e6db74>SendToClient</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token plain">msg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">ClientId</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> msg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">EventType</span><span class="token punctuation" style=color:#f8f8f2>,</span><span class="token plain"> msg</span><span class="token punctuation" style=color:#f8f8f2>.</span><span class="token plain">Data</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">                </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">            </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">        </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token punctuation" style=color:#f8f8f2>(</span><span class="token punctuation" style=color:#f8f8f2>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    </span><span class="token keyword" style=color:#66d9ef>return</span><span class="token plain"> </span><span class="token boolean" style=color:#ae81ff>nil</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<blockquote>
<p>这里也可以使用<code>grpool</code>协程池来管理<code>goroutine</code>。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=55-监控和日志>5.5 监控和日志<a href=#55-监控和日志 class=hash-link aria-label="5.5 监控和日志的直接链接" title="5.5 监控和日志的直接链接">​</a></h3>
<p>实现监控指标收集，以便及时发现问题，至少包含以下关键指标：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#f8f8f2;--prism-background-color:#272822><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-go codeBlock_bY9V thin-scrollbar" style=color:#f8f8f2;background-color:#272822><code class=codeBlockLines_e6Vv><span class=token-line style=color:#f8f8f2><span class="token keyword" style=color:#66d9ef>type</span><span class="token plain"> SseMetrics </span><span class="token keyword" style=color:#66d9ef>struct</span><span class="token plain"> </span><span class="token punctuation" style=color:#f8f8f2>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ActiveConnections    </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 当前活跃连接数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    TotalConnections     </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 总连接数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    MessagesSent         </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 发送的消息数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    MessagesDropped      </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 丢弃的消息数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain">    ReconnectCount       </span><span class="token builtin" style=color:#e6db74>int64</span><span class="token plain"> </span><span class="token comment" style=color:#8292a2;font-style:italic>// 重连次数</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token punctuation" style=color:#f8f8f2>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#f8f8f2><span class="token plain"></span><span class="token comment" style=color:#8292a2;font-style:italic>// ...</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=复制代码到剪贴板 title=复制 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<blockquote>
<p>可以使用框架提供的<code>gmetric</code>组件来实现监控指标的收集和上报，这里不赘述，具体可以参考<code>GoFrame</code>官网的服务可观测性相关章节。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=6-总结>6. 总结<a href=#6-总结 class=hash-link aria-label="6. 总结的直接链接" title="6. 总结的直接链接">​</a></h2>
<p>本文详细介绍了如何在<code>GoFrame</code>框架中实现<code>Server-Sent Events (SSE)</code>技术，从基本概念到实际应用都进行了全面的讲解。</p>
<p><code>SSE</code>作为一种轻量级的实时通信技术，具有实现简单、兼容性好、消耗资源少等优点，非常适合各种需要服务器主动推送数据的场景，如实时通知、数据更新、AI应用等。</p>
<p>在<code>GoFrame</code>中实现<code>SSE</code>的关键点包括：</p>
<ol>
<li>
<p><strong>基础架构</strong>：建立客户端连接管理、消息发送和心跳检测的基础设施</p>
</li>
<li>
<p><strong>消息处理</strong>：实现单客户端消息发送和广播消息的能力，满足不同业务场景</p>
</li>
<li>
<p><strong>分布式部署</strong>：使用<code>Redis</code>的发布/订阅功能实现多实例之间的消息同步</p>
</li>
<li>
<p><strong>性能优化</strong>：通过多协程处理、连接管理和资源限制确保系统稳定性</p>
</li>
<li>
<p><strong>最佳实践</strong>：提供了服务器配置、客户端重连、资源管理等方面的实用建议</p>
</li>
</ol>
<p>通过采用本文提供的方案，开发者可以快速在<code>GoFrame</code>项目中集成<code>SSE</code>功能，构建高性能、可扩展的实时通信系统。无论是开发AI应用、实时仪表盘还是社交平台，<code>SSE</code>都是一个值得考虑的技术选型。</p>
<p>在实际应用中，开发者应根据具体业务需求和系统规模进行适当的调整和优化，例如增强错误处理、添加监控指标或集成更复杂的消息队列系统。</div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/gogf/gf-site/blob/main/docs/community/社区投稿/打造高性能实时通信：Go语言SSE实现指南.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"><span class=theme-last-updated>最后<!-- -->由 <b>John</b> <!-- -->于 <b><time datetime=2025-03-30T06:11:32.000Z itemprop=dateModified>2025年3月30日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label=文�件选项卡><a class="pagination-nav__link pagination-nav__link--prev" href=/articles/rbac-permission-authentication-in-go><div class=pagination-nav__sublabel>上一页</div><div class=pagination-nav__label>为Go应用增加完整的权限认证能力</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/articles/go-ecommerce-database-sharding-millions><div class=pagination-nav__sublabel>下一页</div><div class=pagination-nav__label>突破性能瓶颈：Go语言实现电商系统千万级数据分库分表实战</div></a></nav><div class=docusaurus-mt-lg></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#1-什么是sse class="table-of-contents__link toc-highlight">1. 什么是SSE？</a><li><a href=#2-sse的应用场景 class="table-of-contents__link toc-highlight">2. SSE的应用场景</a><ul><li><a href=#21-实时数据更新 class="table-of-contents__link toc-highlight">2.1 实时数据更新</a><li><a href=#22-系统监控与告警 class="table-of-contents__link toc-highlight">2.2 系统监控与告警</a><li><a href=#23-协作工具 class="table-of-contents__link toc-highlight">2.3 协作工具</a><li><a href=#24-进度反馈 class="table-of-contents__link toc-highlight">2.4 进度反馈</a></ul><li><a href=#3-sse在ai领域的应用 class="table-of-contents__link toc-highlight">3. SSE在AI领域的应用</a><ul><li><a href=#31-大型语言模型的流式响应 class="table-of-contents__link toc-highlight">3.1 大型语言模型的流式响应</a><li><a href=#32-ai图像生成过程 class="table-of-contents__link toc-highlight">3.2 AI图像生成过程</a><li><a href=#33-语音识别和实时翻译 class="table-of-contents__link toc-highlight">3.3 语音识别和实时翻译</a><li><a href=#34-ai辅助编程 class="table-of-contents__link toc-highlight">3.4 AI辅助编程</a></ul><li><a href=#4-使用go实现sse class="table-of-contents__link toc-highlight">4. 使用Go实现SSE</a><ul><li><a href=#41-基础sse实现 class="table-of-contents__link toc-highlight">4.1 基础SSE实现</a><li><a href=#42-实现更灵活的sse服务 class="table-of-contents__link toc-highlight">4.2 实现更灵活的SSE服务</a><li><a href=#43-client_id的设计与客户端交互 class="table-of-contents__link toc-highlight">4.3 client_id的设计与客户端交互</a><li><a href=#44-在ai应用中使用sse的实现 class="table-of-contents__link toc-highlight">4.4 在AI应用中使用SSE的实现</a><li><a href=#45-使用redis实现分布式sse服务 class="table-of-contents__link toc-highlight">4.5 使用Redis实现分布式SSE服务</a></ul><li><a href=#5-sse实现的最佳实践 class="table-of-contents__link toc-highlight">5. SSE实现的最佳实践</a><ul><li><a href=#51-服务器配置 class="table-of-contents__link toc-highlight">5.1 服务器配置</a><li><a href=#52-客户端重连机制 class="table-of-contents__link toc-highlight">5.2 客户端重连机制</a><li><a href=#53-资源管理 class="table-of-contents__link toc-highlight">5.3 资源管理</a><li><a href=#54-消息队列优化 class="table-of-contents__link toc-highlight">5.4 消息队列优化</a><li><a href=#55-监控和日志 class="table-of-contents__link toc-highlight">5.5 监控和日志</a></ul><li><a href=#6-总结 class="table-of-contents__link toc-highlight">6. 总结</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title>微信关注我们</div><ul class="footer__items clean-list"><li class=footer__item><img src=/img/wechat.jpg width=110></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright 2025 GoFrame OpenSource Team</div></div></div></footer></div>